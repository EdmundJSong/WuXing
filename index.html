<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0, minimum-scale=1.0, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<title>五行 Five Elements</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@300;600;900&family=Cormorant+Garamond:ital,wght@0,300;0,500;1,300&display=swap');

  :root {
    --safe-top: env(safe-area-inset-top, 0px);
    --safe-bottom: env(safe-area-inset-bottom, 0px);
    --metal: #d4af37;
    --metal-bg: rgba(212,175,55,0.1);
    --wood: #4c994c;
    --wood-bg: rgba(76,153,76,0.1);
    --water: #4682c8;
    --water-bg: rgba(70,130,200,0.1);
    --fire: #dc3c28;
    --fire-bg: rgba(220,60,40,0.1);
    --earth: #8B5E3C;
    --earth-dim: rgba(139,94,60,0.5);
    --earth-bg: rgba(139,94,60,0.1);
  }

  * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
  
  html, body {
    width: 100%; 
    height: 100%;
    height: -webkit-fill-available;
    overflow: hidden;
    touch-action: none;
    font-family: 'Cormorant Garamond', serif;
    background: #0a0a0a;
    color: #fff;
  }

  /* ── Landing Page ── */
  #landing {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 100%;
    height: -webkit-fill-available;
    padding: 16px 20px;
    padding-top: calc(16px + var(--safe-top));
    padding-bottom: calc(16px + var(--safe-bottom));
    background: #0a0a0a;
    gap: 0;
  }

  #landing h1 {
    font-family: 'Noto Serif SC', serif;
    font-weight: 300;
    font-size: clamp(1.6rem, 6vw, 2.4rem);
    letter-spacing: 0.3em;
    margin-bottom: 2px;
    opacity: 0;
    animation: fadeUp 1s ease forwards;
  }

  #landing .subtitle {
    font-family: 'Cormorant Garamond', serif;
    font-weight: 300;
    font-style: italic;
    font-size: clamp(0.75rem, 3vw, 1rem);
    letter-spacing: 0.15em;
    color: rgba(255,255,255,0.5);
    margin-bottom: clamp(12px, 3vh, 28px);
    opacity: 0;
    animation: fadeUp 1s ease 0.3s forwards;
  }

  .btn-grid {
    display: flex;
    flex-direction: column;
    gap: clamp(6px, 1.2vh, 12px);
    width: 100%;
    max-width: 320px;
  }

  .element-btn {
    width: 100%;
    padding: clamp(12px, 2.2vh, 18px) 20px;
    border: 1px solid rgba(255,255,255,0.15);
    border-radius: 8px;
    background: rgba(255,255,255,0.03);
    color: #fff;
    font-family: 'Noto Serif SC', serif;
    font-size: clamp(0.9rem, 3.5vw, 1.15rem);
    font-weight: 300;
    letter-spacing: 0.2em;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 14px;
    opacity: 0;
    animation: fadeUp 0.6s ease forwards;
  }

  .element-btn:nth-child(1) { animation-delay: 0.4s; }
  .element-btn:nth-child(2) { animation-delay: 0.5s; }
  .element-btn:nth-child(3) { animation-delay: 0.6s; }
  .element-btn:nth-child(4) { animation-delay: 0.7s; }
  .element-btn:nth-child(5) { animation-delay: 0.8s; }

  .element-btn .char {
    font-size: clamp(1.3rem, 5vw, 1.8rem);
    font-weight: 900;
    width: 36px;
    text-align: center;
    flex-shrink: 0;
  }

  .element-btn:active { transform: scale(0.97); }

  .element-btn.metal { border-color: rgba(212,175,55,0.3); }
  .element-btn.metal .char { color: var(--metal); }
  .element-btn.metal:active { background: var(--metal-bg); }

  .element-btn.wood { border-color: rgba(76,153,76,0.3); }
  .element-btn.wood .char { color: var(--wood); }
  .element-btn.wood:active { background: var(--wood-bg); }

  .element-btn.water { border-color: rgba(70,130,200,0.3); }
  .element-btn.water .char { color: var(--water); }
  .element-btn.water:active { background: var(--water-bg); }

  .element-btn.fire { border-color: rgba(220,60,40,0.3); }
  .element-btn.fire .char { color: var(--fire); }
  .element-btn.fire:active { background: var(--fire-bg); }

  .element-btn.earth { border-color: rgba(139,94,60,0.3); }
  .element-btn.earth .char { color: var(--earth); }
  .element-btn.earth:active { background: var(--earth-bg); }

  /* ── Element Pages ── */
  .element-page {
    display: none;
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    flex-direction: column;
    overflow: hidden;
  }

  .element-page.active { display: flex; }

  .bg-char {
    position: absolute;
    top: 46%; left: 50%;
    transform: translate(-50%, -50%);
    font-family: 'Noto Serif SC', serif;
    font-weight: 900;
    font-size: min(70vw, 60vh);
    opacity: 0.06;
    pointer-events: none;
    user-select: none;
    z-index: 0;
  }

  .interaction-area {
    flex: 1;
    position: relative;
    z-index: 10;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding-top: var(--safe-top);
    padding-bottom: calc(60px + var(--safe-bottom));
  }

  /* ── Bottom Navigation ── */
  .bottom-nav {
    position: fixed;
    bottom: 0; left: 0;
    width: 100%;
    height: calc(56px + var(--safe-bottom));
    padding-bottom: var(--safe-bottom);
    display: flex;
    z-index: 200;
    background: rgba(0,0,0,0.8);
    backdrop-filter: blur(16px);
    -webkit-backdrop-filter: blur(16px);
    border-top: 1px solid rgba(255,255,255,0.06);
  }

  .nav-item {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 2px;
    cursor: pointer;
    border: none;
    background: none;
    color: rgba(255,255,255,0.25);
    font-family: 'Noto Serif SC', serif;
    font-size: clamp(1rem, 5vw, 1.3rem);
    font-weight: 900;
    transition: all 0.25s ease;
    position: relative;
  }

  .nav-item .nav-label {
    font-family: 'Cormorant Garamond', serif;
    font-size: clamp(0.4rem, 1.8vw, 0.5rem);
    font-weight: 300;
    letter-spacing: 0.06em;
    text-transform: uppercase;
    opacity: 0.5;
  }

  .nav-item.active { color: rgba(255,255,255,0.9); }
  .nav-item.active::before {
    content: '';
    position: absolute;
    top: 0; left: 25%; right: 25%;
    height: 2px;
    border-radius: 1px;
  }

  .nav-item.metal.active { color: var(--metal); }
  .nav-item.metal.active::before { background: var(--metal); }
  .nav-item.wood.active { color: var(--wood); }
  .nav-item.wood.active::before { background: var(--wood); }
  .nav-item.water.active { color: var(--water); }
  .nav-item.water.active::before { background: var(--water); }
  .nav-item.fire.active { color: var(--fire); }
  .nav-item.fire.active::before { background: var(--fire); }
  .nav-item.earth.active { color: var(--earth); }
  .nav-item.earth.active::before { background: var(--earth); }

  .home-btn {
    position: absolute;
    top: calc(12px + var(--safe-top)); left: 12px;
    z-index: 100;
    background: rgba(0,0,0,0.4);
    border: 1px solid rgba(255,255,255,0.12);
    border-radius: 50%;
    width: 34px; height: 34px;
    color: rgba(255,255,255,0.4);
    font-size: 0.85rem;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    backdrop-filter: blur(8px);
  }

  /* ── Visual Cues — BIG and WHITE ── */

  .shake-cue {
    position: absolute;
    bottom: calc(80px + var(--safe-bottom));
    z-index: 20;
    opacity: 0.5;
    animation: shakeCueAnim 1.2s ease-in-out infinite;
    transition: opacity 0.6s ease;
  }
  .shake-cue svg { width: 80px; height: 80px; }

  @keyframes shakeCueAnim {
    0%, 100% { transform: translateX(0) rotate(0deg); }
    12% { transform: translateX(-12px) rotate(-12deg); }
    24% { transform: translateX(12px) rotate(12deg); }
    36% { transform: translateX(-9px) rotate(-8deg); }
    48% { transform: translateX(9px) rotate(8deg); }
    60% { transform: translateX(-4px) rotate(-3deg); }
    72% { transform: translateX(4px) rotate(3deg); }
    84% { transform: translateX(0) rotate(0); }
  }

  .tilt-cue {
    position: absolute;
    bottom: calc(80px + var(--safe-bottom));
    z-index: 20;
    opacity: 0.5;
    animation: tiltCueAnim 3s ease-in-out infinite;
    transition: opacity 0.6s ease;
  }
  .tilt-cue svg { width: 90px; height: 90px; }

  @keyframes tiltCueAnim {
    0%, 100% { transform: rotate(0deg) translateY(0); }
    20% { transform: rotate(18deg) translateY(-2px); }
    40% { transform: rotate(-3deg) translateY(0); }
    60% { transform: rotate(-18deg) translateY(-2px); }
    80% { transform: rotate(3deg) translateY(0); }
  }

  .hold-cue {
    position: absolute;
    bottom: calc(80px + var(--safe-bottom));
    z-index: 20;
    opacity: 0.5;
    transition: opacity 0.6s ease;
  }
  .hold-cue svg { width: 80px; height: 100px; }

  .cue-hidden { opacity: 0 !important; pointer-events: none; }

  /* ── Metal ── */
  #metal-page { background: radial-gradient(ellipse at 50% 40%, #1a1812 0%, #0d0c08 100%); }
  #metal-page .bg-char { color: var(--metal); }
  
  .metal-ring-visual {
    width: clamp(120px, 35vw, 160px); 
    height: clamp(120px, 35vw, 160px);
    border: 2px solid rgba(212,175,55,0.3);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.15s;
  }

  .metal-ring-visual.shaking {
    border-color: rgba(212,175,55,0.8);
    box-shadow: 0 0 40px rgba(212,175,55,0.3);
    <div class="interaction-area">
    <input type="checkbox" switch id="iosHapticHack" style="position: absolute; opacity: 0; pointer-events: none; z-index: -1;">
    <div class="earth-touch-area" id="earthTouch">
  }

  .metal-ring-visual .inner {
    font-family: 'Noto Serif SC', serif;
    font-size: clamp(1.8rem, 8vw, 2.5rem);
    font-weight: 300;
    color: rgba(212,175,55,0.6);
  }

  /* ── Wood ── */
  #wood-page { background: radial-gradient(ellipse at 50% 40%, #0f1a0f 0%, #080d08 100%); }
  #wood-page .bg-char { color: var(--wood); }

  .xy-pad {
    position: relative;
    width: min(75vw, 260px);
    aspect-ratio: 1;
    border: 1px solid rgba(255,255,255,0.15);
    border-radius: 12px;
    overflow: hidden;
    touch-action: none;
  }

  .xy-pad .crosshair {
    position: absolute;
    width: 22px; height: 22px;
    border: 2px solid rgba(255,255,255,0.6);
    border-radius: 50%;
    transform: translate(-50%, -50%);
    pointer-events: none;
    transition: left 0.05s, top 0.05s;
    left: 50%; top: 50%;
  }

  .trigger-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: clamp(6px, 2vw, 10px);
    margin-top: clamp(10px, 2vh, 20px);
    width: min(75vw, 260px);
  }

  .trigger-btn {
    aspect-ratio: 1.4;
    border: 1px solid rgba(76,153,76,0.3);
    border-radius: 8px;
    background: rgba(76,153,76,0.08);
    color: rgba(255,255,255,0.7);
    font-family: 'Cormorant Garamond', serif;
    font-size: clamp(0.65rem, 2.5vw, 0.75rem);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.1s;
  }

  .trigger-btn:active {
    background: rgba(76,153,76,0.3);
    border-color: rgba(76,153,76,0.7);
    transform: scale(0.95);
  }

  /* ── Water ── */
  #water-page { background: radial-gradient(ellipse at 50% 40%, #0a1220 0%, #060a10 100%); }
  #water-page .bg-char { color: var(--water); }

  .water-visual {
    width: clamp(150px, 40vw, 200px); 
    height: clamp(150px, 40vw, 200px);
    border-radius: 50%;
    border: 1px solid rgba(70,130,200,0.2);
    display: flex;
    align-items: center;
    justify-content: center;
    position: relative;
    overflow: hidden;
  }

  .water-orb {
    width: 50px; height: 50px;
    background: radial-gradient(circle, rgba(70,130,200,0.6), rgba(70,130,200,0));
    border-radius: 50%;
    position: absolute;
    transition: all 0.15s ease-out;
  }

  /* Water tilt readout — large, visible */
  .water-tilt-readout {
    position: absolute;
    bottom: calc(80px + var(--safe-bottom));
    left: 0; right: 0;
    z-index: 20;
    display: flex;
    justify-content: center;
    gap: clamp(16px, 5vw, 30px);
    pointer-events: none;
  }

  .tilt-axis {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 2px;
  }

  .tilt-axis .tilt-label {
    font-family: 'Cormorant Garamond', serif;
    font-size: clamp(0.6rem, 2.5vw, 0.75rem);
    font-weight: 300;
    font-style: italic;
    opacity: 0.4;
    text-transform: uppercase;
    letter-spacing: 0.1em;
  }

  .tilt-axis .tilt-value {
    font-family: 'Noto Serif SC', serif;
    font-size: clamp(1.8rem, 8vw, 2.8rem);
    font-weight: 300;
    color: rgba(255,255,255,0.7);
    line-height: 1;
  }

  .tilt-axis .tilt-unit {
    font-family: 'Cormorant Garamond', serif;
    font-size: clamp(0.55rem, 2vw, 0.7rem);
    opacity: 0.3;
    font-style: italic;
  }

  /* ── Fire ── */
  #fire-page { background: radial-gradient(ellipse at 50% 60%, #1a0a08 0%, #0d0604 100%); }
  #fire-page .bg-char { color: var(--fire); }

  .fire-swipe-area {
    width: min(88vw, 320px);
    flex: 1;
    max-height: 42vh;
    border: 1px solid rgba(220,60,40,0.15);
    border-radius: 16px;
    position: relative;
    overflow: hidden;
    touch-action: none;
  }

  .flame-particle {
    position: absolute;
    width: 8px; height: 8px;
    border-radius: 50%;
    pointer-events: none;
    animation: flameRise 0.8s ease-out forwards;
  }

  @keyframes flameRise {
    0% { opacity: 1; transform: scale(1) translateY(0); }
    100% { opacity: 0; transform: scale(0.2) translateY(-80px); }
  }

  .fire-xy-container { margin-bottom: clamp(8px, 2vh, 16px); }

  /* ── Earth ── */
  #earth-page { background: radial-gradient(ellipse at 50% 50%, #1a1008 0%, #0d0904 100%); }
  #earth-page .bg-char { color: var(--earth); }

  .earth-touch-area {
    width: clamp(150px, 40vw, 200px); 
    height: clamp(150px, 40vw, 200px);
    border: 2px solid rgba(139,94,60,0.25);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s;
    cursor: pointer;
  }

  .earth-touch-area.active {
    border-color: rgba(139,94,60,0.7);
    background: rgba(139,94,60,0.12);
    box-shadow: 0 0 60px rgba(139,94,60,0.2);
  }

  .earth-touch-area .label {
    font-family: 'Noto Serif SC', serif;
    font-size: clamp(1.2rem, 5vw, 1.5rem);
    font-weight: 300;
    opacity: 0.4;
    transition: opacity 0.3s;
    color: var(--earth);
  }

  .earth-touch-area.active .label { opacity: 0.8; }

  .earth-pulse {
    position: absolute;
    width: clamp(150px, 40vw, 200px); 
    height: clamp(150px, 40vw, 200px);
    border: 1px solid rgba(139,94,60,0.3);
    border-radius: 50%;
    animation: earthPulse 1s ease-out forwards;
    pointer-events: none;
  }

  @keyframes earthPulse {
    0% { transform: scale(1); opacity: 0.5; }
    100% { transform: scale(2); opacity: 0; }
  }

  @keyframes fadeUp {
    from { opacity: 0; transform: translateY(12px); }
    to { opacity: 1; transform: translateY(0); }
  }

  /* ── Permission overlay ── */
  .permission-overlay {
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    background: rgba(0,0,0,0.94);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    z-index: 1000;
    padding: 40px;
    padding-top: calc(40px + var(--safe-top));
    text-align: center;
  }

  .permission-overlay.hidden { display: none; }

  .permission-overlay h2 {
    font-family: 'Noto Serif SC', serif;
    font-weight: 300;
    font-size: clamp(1.2rem, 5vw, 1.5rem);
    margin-bottom: 12px;
  }

  .permission-overlay p {
    font-weight: 300;
    font-style: italic;
    opacity: 0.6;
    margin-bottom: 24px;
    line-height: 1.6;
    font-size: clamp(0.75rem, 3vw, 0.9rem);
  }

  .permission-btn {
    padding: 14px 40px;
    border: 1px solid rgba(255,255,255,0.3);
    border-radius: 8px;
    background: rgba(255,255,255,0.08);
    color: #fff;
    font-family: 'Cormorant Garamond', serif;
    font-size: 1rem;
    letter-spacing: 0.1em;
    cursor: pointer;
    transition: background 0.2s;
  }

  .permission-btn:active { background: rgba(255,255,255,0.15); }

  .permission-status {
    margin-top: 16px;
    font-size: 0.7rem;
    opacity: 0.35;
    font-style: italic;
    min-height: 1.2em;
  }
</style>
</head>
<body>

<!-- Permission Overlay -->
<div class="permission-overlay" id="permissionOverlay">
  <h2>五行</h2>
  <p>This experience uses your device's<br>motion sensors, audio, and haptics.</p>
  <button class="permission-btn" id="startBtn">Enter</button>
  <div class="permission-status" id="permStatus"></div>
</div>

<!-- Landing Page -->
<div id="landing">
  <h1>五 行</h1>
  <div class="subtitle">Five Elements</div>
  <div class="btn-grid">
    <button class="element-btn metal" onclick="openElement('metal')">
      <span class="char">金</span> Metal
    </button>
    <button class="element-btn wood" onclick="openElement('wood')">
      <span class="char">木</span> Wood
    </button>
    <button class="element-btn water" onclick="openElement('water')">
      <span class="char">水</span> Water
    </button>
    <button class="element-btn fire" onclick="openElement('fire')">
      <span class="char">火</span> Fire
    </button>
    <button class="element-btn earth" onclick="openElement('earth')">
      <span class="char">土</span> Earth
    </button>
  </div>
</div>

<!-- Metal Page -->
<div class="element-page" id="metal-page">
  <button class="home-btn" onclick="goHome()">⌂</button>
  <div class="bg-char">金</div>
  <div class="interaction-area">
    <div class="metal-ring-visual" id="metalRing">
      <span class="inner">金</span>
    </div>
    <div class="shake-cue" id="metalCue">
      <svg viewBox="0 0 40 40" fill="none" stroke="rgba(255,255,255,0.7)" stroke-width="1.5" stroke-linecap="round">
        <rect x="13" y="7" width="14" height="26" rx="3"/>
        <line x1="5" y1="13" x2="9" y2="10"/>
        <line x1="4" y1="20" x2="9" y2="20"/>
        <line x1="5" y1="27" x2="9" y2="30"/>
        <line x1="35" y1="13" x2="31" y2="10"/>
        <line x1="36" y1="20" x2="31" y2="20"/>
        <line x1="35" y1="27" x2="31" y2="30"/>
      </svg>
    </div>
  </div>
</div>

<!-- Wood Page -->
<div class="element-page" id="wood-page">
  <button class="home-btn" onclick="goHome()">⌂</button>
  <div class="bg-char">木</div>
  <div class="interaction-area">
    <div class="xy-pad" id="woodPad">
      <div class="crosshair" id="woodCrosshair"></div>
    </div>
    <div class="trigger-grid">
      <button class="trigger-btn" data-note="0">C</button>
      <button class="trigger-btn" data-note="1">D</button>
      <button class="trigger-btn" data-note="2">E</button>
      <button class="trigger-btn" data-note="3">G</button>
      <button class="trigger-btn" data-note="4">A</button>
      <button class="trigger-btn" data-note="5">B♭</button>
    </div>
  </div>
</div>

<!-- Water Page -->
<div class="element-page" id="water-page">
  <button class="home-btn" onclick="goHome()">⌂</button>
  <div class="bg-char">水</div>
  <div class="interaction-area">
    <div class="water-visual" id="waterVisual">
      <div class="water-orb" id="waterOrb"></div>
    </div>
    <!-- Tilt cue (shown before first interaction) -->
    <div class="tilt-cue" id="waterCue">
      <svg viewBox="0 0 48 48" fill="none" stroke-linecap="round">
        <rect x="16" y="10" width="16" height="26" rx="3" stroke="rgba(255,255,255,0.7)" stroke-width="1.5"/>
        <path d="M8 23 L3 23" stroke="rgba(255,255,255,0.45)" stroke-width="1.2"/>
        <path d="M6 19.5 L3 23 L6 26.5" stroke="rgba(255,255,255,0.45)" stroke-width="1.2" fill="none"/>
        <path d="M40 23 L45 23" stroke="rgba(255,255,255,0.45)" stroke-width="1.2"/>
        <path d="M42 19.5 L45 23 L42 26.5" stroke="rgba(255,255,255,0.45)" stroke-width="1.2" fill="none"/>
        <path d="M24 5 L24 1" stroke="rgba(255,255,255,0.45)" stroke-width="1.2"/>
        <path d="M20.5 3.5 L24 0.5 L27.5 3.5" stroke="rgba(255,255,255,0.45)" stroke-width="1.2" fill="none"/>
        <path d="M24 43 L24 47" stroke="rgba(255,255,255,0.45)" stroke-width="1.2"/>
        <path d="M20.5 44.5 L24 47.5 L27.5 44.5" stroke="rgba(255,255,255,0.45)" stroke-width="1.2" fill="none"/>
      </svg>
    </div>
    <!-- Tilt degree readout (always visible once interacting) -->
    <div class="water-tilt-readout" id="waterReadout" style="opacity:0;">
      <div class="tilt-axis">
        <span class="tilt-label">Tilt</span>
        <span class="tilt-value" id="tiltBeta">0°</span>
      </div>
      <div class="tilt-axis">
        <span class="tilt-label">Roll</span>
        <span class="tilt-value" id="tiltGamma">0°</span>
      </div>
      <div class="tilt-axis">
        <span class="tilt-label">Spin</span>
        <span class="tilt-value" id="tiltAlpha">0°</span>
      </div>
    </div>
  </div>
</div>

<!-- Fire Page -->
<div class="element-page" id="fire-page">
  <button class="home-btn" onclick="goHome()">⌂</button>
  <div class="bg-char">火</div>
  <div class="interaction-area">
    <div class="fire-xy-container">
      <div class="xy-pad" id="firePad" style="border-color: rgba(220,60,40,0.15); max-width: 200px;">
        <div class="crosshair" id="fireCrosshair"></div>
      </div>
    </div>
    <div class="fire-swipe-area" id="fireSwipeArea"></div>
  </div>
</div>

<!-- Earth Page -->
<div class="element-page" id="earth-page">
  <button class="home-btn" onclick="goHome()">⌂</button>
  <div class="bg-char">土</div>
  <div class="interaction-area">
    <div class="earth-touch-area" id="earthTouch">
      <span class="label">土</span>
    </div>
    <div class="hold-cue" id="earthCue">
      <svg viewBox="0 0 44 56" fill="none" stroke-linecap="round">
        <ellipse cx="22" cy="18" rx="7" ry="9" stroke="rgba(255,255,255,0.7)" stroke-width="1.5"/>
        <line x1="22" y1="27" x2="22" y2="38" stroke="rgba(255,255,255,0.7)" stroke-width="1.5"/>
        <circle cx="22" cy="43" r="4" stroke="rgba(255,255,255,0.4)" stroke-width="1">
          <animate attributeName="r" from="4" to="14" dur="2s" repeatCount="indefinite"/>
          <animate attributeName="opacity" from="0.6" to="0" dur="2s" repeatCount="indefinite"/>
        </circle>
        <circle cx="22" cy="43" r="4" stroke="rgba(255,255,255,0.4)" stroke-width="1">
          <animate attributeName="r" from="4" to="14" dur="2s" begin="1s" repeatCount="indefinite"/>
          <animate attributeName="opacity" from="0.6" to="0" dur="2s" begin="1s" repeatCount="indefinite"/>
        </circle>
        <circle cx="22" cy="43" r="3" fill="rgba(255,255,255,0.45)"/>
      </svg>
    </div>
  </div>
</div>

<!-- Bottom Navigation -->
<div class="bottom-nav" id="bottomNav" style="display:none;">
  <button class="nav-item metal" onclick="switchElement('metal')">
    <span>金</span>
    <span class="nav-label">Metal</span>
  </button>
  <button class="nav-item wood" onclick="switchElement('wood')">
    <span>木</span>
    <span class="nav-label">Wood</span>
  </button>
  <button class="nav-item water" onclick="switchElement('water')">
    <span>水</span>
    <span class="nav-label">Water</span>
  </button>
  <button class="nav-item fire" onclick="switchElement('fire')">
    <span>火</span>
    <span class="nav-label">Fire</span>
  </button>
  <button class="nav-item earth" onclick="switchElement('earth')">
    <span>土</span>
    <span class="nav-label">Earth</span>
  </button>
</div>

<script>
// ════════════════════════════════════════
// Viewport height fix
// ════════════════════════════════════════
function setVH(){document.documentElement.style.setProperty('--vh',window.innerHeight+'px');}
setVH(); window.addEventListener('resize',setVH);

// ════════════════════════════════════════
// Audio Context & Core
// ════════════════════════════════════════
let audioCtx=null, currentElement=null;

function initAudio(){
  if(!audioCtx) audioCtx=new(window.AudioContext||window.webkitAudioContext)();
  if(audioCtx.state==='suspended') audioCtx.resume();
}

// ════════════════════════════════════════
// Permissions — ALL on entry
// ════════════════════════════════════════
document.getElementById('startBtn').addEventListener('click', async()=>{
  const status=document.getElementById('permStatus');
  status.textContent='Requesting permissions…';
  initAudio();
  if(typeof DeviceMotionEvent!=='undefined'&&typeof DeviceMotionEvent.requestPermission==='function'){
    try{const r=await DeviceMotionEvent.requestPermission();if(r!=='granted')status.textContent='Motion access needed';}catch(e){}
  }
  if(typeof DeviceOrientationEvent!=='undefined'&&typeof DeviceOrientationEvent.requestPermission==='function'){
    try{const r=await DeviceOrientationEvent.requestPermission();if(r!=='granted')status.textContent='Orientation access needed';}catch(e){}
  }
  if(navigator.vibrate) navigator.vibrate(1);
  if('wakeLock' in navigator){try{await navigator.wakeLock.request('screen');}catch(e){}}
  document.getElementById('permissionOverlay').classList.add('hidden');
});

// ════════════════════════════════════════
// Navigation
// ════════════════════════════════════════
function openElement(name){
  initAudio();
  document.getElementById('landing').style.display='none';
  document.getElementById('bottomNav').style.display='flex';
  switchElement(name);
}

function switchElement(name){
  if(currentElement===name) return;
  if(currentElement) cleanupCurrent();
  document.querySelectorAll('.element-page').forEach(p=>p.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active'));
  document.querySelector(`.nav-item.${name}`).classList.add('active');
  document.getElementById(name+'-page').classList.add('active');
  currentElement=name;
  initAudio();
  ({metal:initMetal,wood:initWood,water:initWater,fire:initFire,earth:initEarth})[name]();
}

function goHome(){
  cleanupCurrent();
  document.querySelectorAll('.element-page').forEach(p=>p.classList.remove('active'));
  document.getElementById('bottomNav').style.display='none';
  document.getElementById('landing').style.display='flex';
  currentElement=null;
}

function cleanupCurrent(){
  ({metal:cleanupMetal,wood:cleanupWood,water:cleanupWater,fire:cleanupFire,earth:cleanupEarth})[currentElement]();
}

function hideCue(id){const c=document.getElementById(id);if(c)c.classList.add('cue-hidden');}
function resetCue(id){const c=document.getElementById(id);if(c)c.classList.remove('cue-hidden');}

// ════════════════════════════════════════
// Drone utility
// ════════════════════════════════════════
function createDrone(baseFreq,type,detune){
  const o1=audioCtx.createOscillator(),o2=audioCtx.createOscillator();
  const g=audioCtx.createGain(),f=audioCtx.createBiquadFilter();
  o1.type=type||'sine';o1.frequency.value=baseFreq;
  o2.type='sine';o2.frequency.value=baseFreq*1.002;
  if(detune){o1.detune.value=detune;o2.detune.value=-detune;}
  f.type='lowpass';f.frequency.value=800;f.Q.value=2;
  g.gain.value=0;
  o1.connect(f);o2.connect(f);f.connect(g);g.connect(audioCtx.destination);
  o1.start();o2.start();
  return{osc1:o1,osc2:o2,gain:g,filter:f};
}

// ════════════════════════════════════════
// 1. METAL 金
// ════════════════════════════════════════
let metalHandler=null,metalLastShake=0;

function initMetal(){
  resetCue('metalCue');
  metalHandler=e=>{
    const a=e.accelerationIncludingGravity||e.acceleration;if(!a)return;
    const m=Math.sqrt(a.x*a.x+a.y*a.y+a.z*a.z),now=Date.now();
    if(m>18&&now-metalLastShake>120){metalLastShake=now;hideCue('metalCue');triggerMetalRing(Math.min(m/40,1));}
  };
  window.addEventListener('devicemotion',metalHandler);
  document.getElementById('metalRing').addEventListener('touchstart',metalTap);
}
function metalTap(){hideCue('metalCue');triggerMetalRing(0.7);}

function triggerMetalRing(int){
  const ring=document.getElementById('metalRing');
  ring.classList.add('shaking');setTimeout(()=>ring.classList.remove('shaking'),200);
  const t=audioCtx.currentTime,f=800+Math.random()*600;
  const mod=audioCtx.createOscillator(),mg=audioCtx.createGain();
  const car=audioCtx.createOscillator(),env=audioCtx.createGain();
  mod.frequency.value=f*1.4;mg.gain.value=f*2;car.frequency.value=f;
  mod.connect(mg);mg.connect(car.frequency);car.connect(env);env.connect(audioCtx.destination);
  env.gain.setValueAtTime(int*0.25,t);env.gain.exponentialRampToValueAtTime(0.001,t+1.5);
  mod.start(t);car.start(t);mod.stop(t+1.6);car.stop(t+1.6);
}

function cleanupMetal(){
  if(metalHandler)window.removeEventListener('devicemotion',metalHandler);
  document.getElementById('metalRing').removeEventListener('touchstart',metalTap);
  metalHandler=null;
}

// ════════════════════════════════════════
// 2. WOOD 木
// ════════════════════════════════════════
let woodDrone=null,woodPadActive=false;

function initWood(){
  woodDrone=createDrone(110,'sawtooth',5);woodDrone.filter.frequency.value=300;
  const pad=document.getElementById('woodPad'),cross=document.getElementById('woodCrosshair');
  const mv=(x,y)=>{
    const r=pad.getBoundingClientRect();
    const nx=Math.max(0,Math.min(1,(x-r.left)/r.width)),ny=Math.max(0,Math.min(1,(y-r.top)/r.height));
    cross.style.left=(nx*100)+'%';cross.style.top=(ny*100)+'%';
    woodDrone.filter.frequency.value=200+nx*2000;woodDrone.gain.gain.value=(1-ny)*0.3;
  };
  pad.addEventListener('touchstart',e=>{e.preventDefault();woodPadActive=true;mv(e.touches[0].clientX,e.touches[0].clientY);});
  pad.addEventListener('touchmove',e=>{e.preventDefault();if(woodPadActive)mv(e.touches[0].clientX,e.touches[0].clientY);});
  pad.addEventListener('touchend',()=>{woodPadActive=false;woodDrone.gain.gain.linearRampToValueAtTime(0,audioCtx.currentTime+0.3);cross.style.left='50%';cross.style.top='50%';});
  const notes=[261.6,293.7,329.6,392.0,440.0,466.2];
  document.querySelectorAll('#wood-page .trigger-btn').forEach((b,i)=>{
    b.addEventListener('touchstart',e=>{e.preventDefault();triggerWoodPerc(notes[i],i<4);});
  });
}

function triggerWoodPerc(freq,isM){
  const t=audioCtx.currentTime;
  if(isM){
    const o=audioCtx.createOscillator(),e=audioCtx.createGain();
    o.type='sine';o.frequency.value=freq;o.connect(e);e.connect(audioCtx.destination);
    e.gain.setValueAtTime(0.3,t);e.gain.exponentialRampToValueAtTime(0.001,t+0.5);
    o.start(t);o.stop(t+0.6);
  }else{
    const bs=audioCtx.sampleRate*0.08,buf=audioCtx.createBuffer(1,bs,audioCtx.sampleRate);
    const d=buf.getChannelData(0);for(let i=0;i<bs;i++)d[i]=Math.random()*2-1;
    const s=audioCtx.createBufferSource();s.buffer=buf;
    const bp=audioCtx.createBiquadFilter();bp.type='bandpass';bp.frequency.value=freq*2;bp.Q.value=10;
    const e=audioCtx.createGain();e.gain.setValueAtTime(0.25,t);e.gain.exponentialRampToValueAtTime(0.001,t+0.1);
    s.connect(bp);bp.connect(e);e.connect(audioCtx.destination);s.start(t);
  }
}

function cleanupWood(){if(woodDrone){woodDrone.osc1.stop();woodDrone.osc2.stop();woodDrone=null;}}

// ════════════════════════════════════════
// 3. WATER 水 — Gyro with large tilt readout
// ════════════════════════════════════════
let waterDrone=null,waterOrientHandler=null;

// Baseline: when phone screen faces user at ~60° from flat, 
// beta ≈ 60. We treat that as "neutral" so the readout shows 
// relative tilt from comfortable holding position.
const BETA_NEUTRAL = 60;

function initWater(){
  resetCue('waterCue');
  document.getElementById('waterReadout').style.opacity='0';

  waterDrone=createDrone(80,'sine',3);waterDrone.gain.gain.value=0.15;
  const lfo=audioCtx.createOscillator(),lg=audioCtx.createGain();
  lfo.type='sine';lfo.frequency.value=0.3;lg.gain.value=20;
  lfo.connect(lg);lg.connect(waterDrone.filter.frequency);lfo.start();
  waterDrone.lfo=lfo;waterDrone.lfoGain=lg;

  const orb=document.getElementById('waterOrb');
  const vis=document.getElementById('waterVisual');
  const readout=document.getElementById('waterReadout');
  const valBeta=document.getElementById('tiltBeta');
  const valGamma=document.getElementById('tiltGamma');
  const valAlpha=document.getElementById('tiltAlpha');

  waterOrientHandler=e=>{
    const beta=e.beta||0,gamma=e.gamma||0,alpha=e.alpha||0;

    // Hide cue, show readout
    hideCue('waterCue');
    readout.style.opacity='1';

    // Relative tilt from comfortable holding angle
    const relBeta=Math.round(beta-BETA_NEUTRAL);
    const relGamma=Math.round(gamma);
    const relAlpha=Math.round(alpha);

    valBeta.textContent=relBeta+'°';
    valGamma.textContent=relGamma+'°';
    valAlpha.textContent=relAlpha+'°';

    // Normalize for sound (using raw values for full range)
    const nx=(gamma+90)/180;
    const ny=(beta+180)/360;
    const nz=alpha/360;

    waterDrone.osc1.frequency.value=60+nx*200;
    waterDrone.osc2.frequency.value=62+nx*200;
    waterDrone.filter.frequency.value=200+ny*2000;
    waterDrone.lfo.frequency.value=0.1+nz*4;

    const sz=vis.clientWidth;
    orb.style.left=(nx*(sz-50))+'px';
    orb.style.top=(ny*(sz-50))+'px';
    orb.style.width=(35+nz*30)+'px';
    orb.style.height=(35+nz*30)+'px';
  };
  window.addEventListener('deviceorientation',waterOrientHandler);

  // Fallback: touch
  vis.addEventListener('touchmove',e=>{
    e.preventDefault();hideCue('waterCue');readout.style.opacity='1';
    const r=vis.getBoundingClientRect(),t=e.touches[0];
    const nx=Math.max(0,Math.min(1,(t.clientX-r.left)/r.width));
    const ny=Math.max(0,Math.min(1,(t.clientY-r.top)/r.height));
    waterDrone.osc1.frequency.value=60+nx*200;
    waterDrone.filter.frequency.value=200+ny*2000;
    orb.style.left=(nx*(vis.clientWidth-50))+'px';
    orb.style.top=(ny*(vis.clientHeight-50))+'px';
    valBeta.textContent=Math.round(ny*180-90)+'°';
    valGamma.textContent=Math.round(nx*180-90)+'°';
  });
}

function cleanupWater(){
  if(waterOrientHandler)window.removeEventListener('deviceorientation',waterOrientHandler);
  waterOrientHandler=null;
  document.getElementById('waterReadout').style.opacity='0';
  if(waterDrone){waterDrone.osc1.stop();waterDrone.osc2.stop();waterDrone.lfo.stop();waterDrone=null;}
}

// ════════════════════════════════════════
// 4. FIRE 火
// ════════════════════════════════════════
let fireDrone=null,firePadActive=false,fireLastSwipe=0;

function initFire(){
  fireDrone=createDrone(150,'sawtooth',8);fireDrone.filter.frequency.value=400;
  const pad=document.getElementById('firePad'),cross=document.getElementById('fireCrosshair');
  const mv=(x,y)=>{
    const r=pad.getBoundingClientRect();
    const nx=Math.max(0,Math.min(1,(x-r.left)/r.width)),ny=Math.max(0,Math.min(1,(y-r.top)/r.height));
    cross.style.left=(nx*100)+'%';cross.style.top=(ny*100)+'%';
    fireDrone.filter.frequency.value=300+nx*3000;fireDrone.gain.gain.value=(1-ny)*0.25;
  };
  pad.addEventListener('touchstart',e=>{e.preventDefault();firePadActive=true;mv(e.touches[0].clientX,e.touches[0].clientY);});
  pad.addEventListener('touchmove',e=>{e.preventDefault();if(firePadActive)mv(e.touches[0].clientX,e.touches[0].clientY);});
  pad.addEventListener('touchend',()=>{firePadActive=false;fireDrone.gain.gain.linearRampToValueAtTime(0,audioCtx.currentTime+0.3);cross.style.left='50%';cross.style.top='50%';});
  const sa=document.getElementById('fireSwipeArea');let ss=null;
  sa.addEventListener('touchstart',e=>{e.preventDefault();ss={x:e.touches[0].clientX,y:e.touches[0].clientY};});
  sa.addEventListener('touchmove',e=>{
    e.preventDefault();if(!ss)return;const now=Date.now();if(now-fireLastSwipe<80)return;
    const dx=e.touches[0].clientX-ss.x,dy=e.touches[0].clientY-ss.y,dist=Math.sqrt(dx*dx+dy*dy);
    if(dist>20){fireLastSwipe=now;const r=sa.getBoundingClientRect();
      spawnFlame(e.touches[0].clientX-r.left,e.touches[0].clientY-r.top,sa);
      triggerFlameSound(dist/200);ss={x:e.touches[0].clientX,y:e.touches[0].clientY};}
  });
  sa.addEventListener('touchend',()=>{ss=null;});
}

function spawnFlame(x,y,c){
  const el=document.createElement('div');el.className='flame-particle';
  el.style.background=`hsl(${10+Math.random()*30},90%,55%)`;
  el.style.left=x+'px';el.style.top=y+'px';
  const s=6+Math.random()*10;el.style.width=s+'px';el.style.height=s+'px';
  c.appendChild(el);setTimeout(()=>el.remove(),800);
}

function triggerFlameSound(int){
  const t=audioCtx.currentTime,bs=audioCtx.sampleRate*0.15,buf=audioCtx.createBuffer(1,bs,audioCtx.sampleRate);
  const d=buf.getChannelData(0);for(let i=0;i<bs;i++)d[i]=Math.random()*2-1;
  const s=audioCtx.createBufferSource();s.buffer=buf;
  const bp=audioCtx.createBiquadFilter();bp.type='bandpass';bp.frequency.value=1000+Math.random()*3000;bp.Q.value=2;
  const e=audioCtx.createGain();e.gain.setValueAtTime(Math.min(int,1)*0.2,t);e.gain.exponentialRampToValueAtTime(0.001,t+0.15);
  s.connect(bp);bp.connect(e);e.connect(audioCtx.destination);s.start(t);
}

function cleanupFire(){if(fireDrone){fireDrone.osc1.stop();fireDrone.osc2.stop();fireDrone=null;}}

// ════════════════════════════════════════
// 5. EARTH 土 — Stronger haptic pulse
// ════════════════════════════════════════
let earthDrone=null,earthHapticInterval=null,earthPulseContainer=null;

function initEarth(){
  resetCue('earthCue');
  earthDrone=createDrone(55,'sine',2);earthDrone.filter.frequency.value=400;
  const ta=document.getElementById('earthTouch');
  earthPulseContainer=ta.parentElement;
  ta.addEventListener('touchstart',earthTS);
  ta.addEventListener('touchend',earthTE);
  ta.addEventListener('touchcancel',earthTE);
}

function earthTS(e){
  e.preventDefault();hideCue('earthCue');
  document.getElementById('earthTouch').classList.add('active');
  earthDrone.gain.gain.linearRampToValueAtTime(0.25,audioCtx.currentTime+0.5);

  // Immediate first pulse — strong pattern: vibrate-pause-vibrate
  doEarthVibrate();
  spawnEarthPulse();

  // Repeat every 1 second
  earthHapticInterval=setInterval(()=>{
    doEarthVibrate();
    spawnEarthPulse();
  },1000);
}

function doEarthVibrate(){
  if(!navigator.vibrate) return;
  // Pattern: 100ms on, 50ms off, 100ms on — a strong double-tap pulse
  navigator.vibrate([100, 50, 100]);
}

function earthTE(){
  document.getElementById('earthTouch').classList.remove('active');
  if(earthDrone) earthDrone.gain.gain.linearRampToValueAtTime(0,audioCtx.currentTime+0.8);
  if(earthHapticInterval){clearInterval(earthHapticInterval);earthHapticInterval=null;}
  // Cancel any ongoing vibration
  if(navigator.vibrate) navigator.vibrate(0);
}

function spawnEarthPulse(){
  const el=document.createElement('div');el.className='earth-pulse';
  const ta=document.getElementById('earthTouch');
  const r=ta.getBoundingClientRect(),pr=earthPulseContainer.getBoundingClientRect();
  const sz=ta.clientWidth;
  el.style.width=sz+'px';el.style.height=sz+'px';
  el.style.left=(r.left-pr.left+r.width/2-sz/2)+'px';
  el.style.top=(r.top-pr.top+r.height/2-sz/2)+'px';
  earthPulseContainer.appendChild(el);setTimeout(()=>el.remove(),1000);
}

function cleanupEarth(){
  if(earthDrone){earthDrone.osc1.stop();earthDrone.osc2.stop();earthDrone=null;}
  if(earthHapticInterval){clearInterval(earthHapticInterval);earthHapticInterval=null;}
  if(navigator.vibrate) navigator.vibrate(0);
  const ta=document.getElementById('earthTouch');
  ta.removeEventListener('touchstart',earthTS);
  ta.removeEventListener('touchend',earthTE);
  ta.removeEventListener('touchcancel',earthTE);
}

document.addEventListener('touchmove',e=>{if(currentElement)e.preventDefault();},{passive:false});
</script>
</body>
</html>
