<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0, minimum-scale=1.0, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<title>五行 Five Elements</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@300;600;900&family=Cormorant+Garamond:ital,wght@0,300;0,500;1,300&display=swap');

  :root {
    --safe-top: env(safe-area-inset-top, 0px);
    --safe-bottom: env(safe-area-inset-bottom, 0px);
    --metal: #d4af37;
    --wood: #4c994c;
    --water: #4682c8;
    --fire: #dc3c28;
    --earth: #8B5E3C;
  }

  * {
    margin: 0; padding: 0; box-sizing: border-box;
    -webkit-tap-highlight-color: transparent;
    touch-action: manipulation;
  }
  html, body {
    width: 100%; height: 100%; height: -webkit-fill-available;
    overflow: hidden;
    font-family: 'Cormorant Garamond', serif;
    background: #0a0a0a; color: #fff;
  }

  /* ═══════════════════════════════════
     PERMISSION OVERLAY
     ═══════════════════════════════════ */
  .permission-overlay {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.94); display: flex; flex-direction: column;
    align-items: center; justify-content: center; z-index: 1000;
    padding: 40px; padding-top: calc(40px + var(--safe-top)); text-align: center;
  }
  .permission-overlay.hidden { display: none; }
  .permission-overlay h2 {
    font-family: 'Noto Serif SC', serif; font-weight: 300;
    font-size: clamp(1.2rem, 5vw, 1.5rem); margin-bottom: 12px;
  }
  .permission-overlay p {
    font-weight: 300; font-style: italic; opacity: 0.6;
    margin-bottom: 20px; line-height: 1.6; font-size: clamp(0.75rem, 3vw, 0.9rem);
  }
  .setup-hint {
    font-weight: 300; font-style: italic;
    opacity: 0.35; margin-bottom: 24px;
    font-size: clamp(1rem, 4vw, 1.2rem);
    letter-spacing: 0.08em;
  }
  .permission-btn {
    padding: 14px 40px; border: 1px solid rgba(255,255,255,0.3);
    border-radius: 8px; background: rgba(255,255,255,0.08);
    color: #fff; font-family: 'Cormorant Garamond', serif;
    font-size: 1rem; letter-spacing: 0.1em; cursor: pointer;
  }
  .permission-btn:active { background: rgba(255,255,255,0.15); }
  .permission-status { margin-top: 16px; font-size: 0.7rem; opacity: 0.35; font-style: italic; }

  /* ═══════════════════════════════════
     LANDING
     ═══════════════════════════════════ */
  #landing {
    display: flex; align-items: center; justify-content: center;
    height: 100%; height: -webkit-fill-available;
    padding: 20px; background: #0a0a0a; position: relative;
  }
  .circle-layout {
    position: relative;
    width: min(80vw, 80vh, 360px); height: min(80vw, 80vh, 360px);
  }
  .circle-ring {
    position: absolute; top: 50%; left: 50%;
    width: 85%; height: 85%; transform: translate(-50%, -50%);
    border: 1px solid rgba(255,255,255,0.08); border-radius: 50%;
    pointer-events: none;
  }
  .energy-canvas {
    position: absolute; top: 0; left: 0;
    pointer-events: none; z-index: 1;
  }
  .circle-center {
    position: absolute; top: 50%; left: 50%;
    transform: translate(-50%, -50%);
    text-align: center; z-index: 5; cursor: pointer; padding: 16px;
  }
  .circle-center h1 {
    font-family: 'Noto Serif SC', serif; font-weight: 300;
    font-size: clamp(1.4rem, 5vw, 2rem); letter-spacing: 0.25em;
    opacity: 0; animation: fadeIn 1s ease 0.2s forwards;
    transition: opacity 0.3s ease;
  }
  .circle-center .subtitle {
    font-family: 'Cormorant Garamond', serif; font-weight: 300;
    font-style: italic; font-size: clamp(0.65rem, 2.5vw, 0.85rem);
    letter-spacing: 0.12em; color: rgba(255,255,255,0.4);
    margin-top: 2px; opacity: 0; animation: fadeIn 1s ease 0.5s forwards;
  }
  .circle-el {
    position: absolute;
    width: clamp(52px, 16vw, 68px); height: clamp(52px, 16vw, 68px);
    border-radius: 50%; border: 1px solid rgba(255,255,255,0.15);
    background: rgba(255,255,255,0.03);
    display: flex; flex-direction: column;
    align-items: center; justify-content: center;
    cursor: pointer; transform: translate(-50%, -50%);
    opacity: 0; animation: fadeIn 0.6s ease forwards; gap: 1px;
    z-index: 10;
    transition: top 0.7s cubic-bezier(0.4,0,0.2,1), left 0.7s cubic-bezier(0.4,0,0.2,1);
  }
  .circle-el:active { filter: brightness(1.3); }
  .circle-el .char {
    font-family: 'Noto Serif SC', serif;
    font-size: clamp(1.1rem, 4vw, 1.5rem); font-weight: 900; line-height: 1;
  }
  .circle-el .elname {
    font-family: 'Cormorant Garamond', serif;
    font-size: clamp(0.45rem, 1.8vw, 0.55rem); font-weight: 300;
    letter-spacing: 0.08em; text-transform: uppercase; opacity: 0.5;
  }
  .circle-el:nth-child(1) { animation-delay: 0.4s; }
  .circle-el:nth-child(2) { animation-delay: 0.5s; }
  .circle-el:nth-child(3) { animation-delay: 0.6s; }
  .circle-el:nth-child(4) { animation-delay: 0.7s; }
  .circle-el:nth-child(5) { animation-delay: 0.8s; }
  .circle-el.c-metal { border-color: rgba(212,175,55,0.3); }
  .circle-el.c-metal .char { color: var(--metal); }
  .circle-el.c-wood { border-color: rgba(76,153,76,0.3); }
  .circle-el.c-wood .char { color: var(--wood); }
  .circle-el.c-water { border-color: rgba(70,130,200,0.3); }
  .circle-el.c-water .char { color: var(--water); }
  .circle-el.c-fire { border-color: rgba(220,60,40,0.3); }
  .circle-el.c-fire .char { color: var(--fire); }
  .circle-el.c-earth { border-color: rgba(139,94,60,0.3); }
  .circle-el.c-earth .char { color: var(--earth); }

  /* ═══════════════════════════════════
     SHARED
     ═══════════════════════════════════ */
  .element-page {
    display: none; position: fixed; top: 0; left: 0;
    width: 100%; height: 100%; flex-direction: column; overflow: hidden;
  }
  .element-page.active { display: flex; }
  .bg-char {
    position: absolute; top: 46%; left: 50%;
    transform: translate(-50%, -50%);
    font-family: 'Noto Serif SC', serif; font-weight: 900;
    font-size: min(70vw, 60vh); opacity: 0.06;
    pointer-events: none; user-select: none; z-index: 0;
  }
  .interaction-area {
    flex: 1; position: relative; z-index: 10;
    display: flex; flex-direction: column;
    align-items: center; justify-content: center;
    padding-top: var(--safe-top);
    padding-bottom: calc(60px + var(--safe-bottom));
  }
  .bottom-nav {
    position: fixed; bottom: 0; left: 0; width: 100%;
    height: calc(56px + var(--safe-bottom)); padding-bottom: var(--safe-bottom);
    display: flex; z-index: 200; background: rgba(0,0,0,0.8);
    backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px);
    border-top: 1px solid rgba(255,255,255,0.06);
  }
  .nav-item {
    flex: 1; display: flex; flex-direction: column;
    align-items: center; justify-content: center; gap: 2px;
    cursor: pointer; border: none; background: none;
    color: rgba(255,255,255,0.25); font-family: 'Noto Serif SC', serif;
    font-size: clamp(1rem, 5vw, 1.3rem); font-weight: 900;
    transition: all 0.25s ease; position: relative;
  }
  .nav-item .nav-label {
    font-family: 'Cormorant Garamond', serif;
    font-size: clamp(0.4rem, 1.8vw, 0.5rem); font-weight: 300;
    letter-spacing: 0.06em; text-transform: uppercase; opacity: 0.5;
  }
  .nav-item.active { color: rgba(255,255,255,0.9); }
  .nav-item.active::before {
    content: ''; position: absolute; top: 0; left: 25%; right: 25%;
    height: 2px; border-radius: 1px;
  }
  .nav-item.metal.active { color: var(--metal); }
  .nav-item.metal.active::before { background: var(--metal); }
  .nav-item.wood.active { color: var(--wood); }
  .nav-item.wood.active::before { background: var(--wood); }
  .nav-item.water.active { color: var(--water); }
  .nav-item.water.active::before { background: var(--water); }
  .nav-item.fire.active { color: var(--fire); }
  .nav-item.fire.active::before { background: var(--fire); }
  .nav-item.earth.active { color: var(--earth); }
  .nav-item.earth.active::before { background: var(--earth); }
  .home-btn {
    position: absolute; top: calc(12px + var(--safe-top)); left: 12px;
    z-index: 100; background: rgba(0,0,0,0.4);
    border: 1px solid rgba(255,255,255,0.12); border-radius: 50%;
    width: 34px; height: 34px; color: rgba(255,255,255,0.4);
    font-size: 0.85rem; cursor: pointer;
    display: flex; align-items: center; justify-content: center;
    backdrop-filter: blur(8px);
  }
  .cue-visible { opacity: 0.45; transition: opacity 0.8s ease; }
  .cue-hidden { opacity: 0 !important; transition: opacity 0.5s ease; pointer-events: none; }

  /* ═══════════════════════════════════
     METAL
     ═══════════════════════════════════ */
  #metal-page { background: radial-gradient(ellipse at 50% 40%, #1a1812 0%, #0d0c08 100%); }
  #metal-page .bg-char { color: var(--metal); }
  .metal-ring-visual {
    width: clamp(140px, 40vw, 180px); height: clamp(140px, 40vw, 180px);
    border: 2px solid rgba(212,175,55,0.3); border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    transition: all 0.15s; position: relative; overflow: hidden;
  }
  .metal-ring-visual.shaking {
    border-color: rgba(212,175,55,0.8);
    box-shadow: 0 0 40px rgba(212,175,55,0.3);
  }
  .metal-shake-icon {
    opacity: 0.45; animation: shakeCueAnim 1.2s ease-in-out infinite;
    transition: opacity 0.5s ease;
  }
  .metal-shake-icon svg { width: 70px; height: 70px; }
  @keyframes shakeCueAnim {
    0%, 100% { transform: translateX(0) rotate(0deg); }
    12% { transform: translateX(-10px) rotate(-12deg); }
    24% { transform: translateX(10px) rotate(12deg); }
    36% { transform: translateX(-8px) rotate(-8deg); }
    48% { transform: translateX(8px) rotate(8deg); }
    60% { transform: translateX(-4px) rotate(-3deg); }
    72% { transform: translateX(4px) rotate(3deg); }
  }

  /* ═══════════════════════════════════
     WOOD
     ═══════════════════════════════════ */
  #wood-page { background: radial-gradient(ellipse at 50% 40%, #0f1a0f 0%, #080d08 100%); }
  #wood-page .bg-char { color: var(--wood); }
  .xy-pad {
    position: relative; width: min(75vw, 260px); aspect-ratio: 1;
    border: 1px solid rgba(255,255,255,0.15); border-radius: 12px;
    overflow: hidden; touch-action: none;
  }
  .xy-pad .crosshair {
    position: absolute; width: 22px; height: 22px;
    border: 2px solid rgba(255,255,255,0.6); border-radius: 50%;
    transform: translate(-50%, -50%); pointer-events: none;
    left: 50%; top: 50%; z-index: 2;
  }
  .xy-pad .ghost-cursor {
    position: absolute; width: 22px; height: 22px;
    border: 1.5px solid rgba(255,255,255,0.25); border-radius: 50%;
    transform: translate(-50%, -50%); pointer-events: none; z-index: 1;
    transition: opacity 0.5s ease;
  }
  .wood-ghost { animation: woodGhostMove 4s ease-in-out infinite; }
  @keyframes woodGhostMove {
    0% { left: 50%; top: 50%; } 15% { left: 25%; top: 30%; }
    30% { left: 70%; top: 25%; } 50% { left: 75%; top: 65%; }
    70% { left: 30%; top: 70%; } 85% { left: 40%; top: 40%; }
    100% { left: 50%; top: 50%; }
  }
  .trigger-grid {
    display: grid; grid-template-columns: repeat(3, 1fr);
    gap: clamp(6px, 2vw, 10px); margin-top: clamp(10px, 2vh, 20px);
    width: min(75vw, 260px);
  }
  .trigger-btn {
    aspect-ratio: 1.4; border: 1px solid rgba(76,153,76,0.3);
    border-radius: 8px; background: rgba(76,153,76,0.08);
    color: rgba(255,255,255,0.7); font-family: 'Cormorant Garamond', serif;
    font-size: clamp(0.65rem, 2.5vw, 0.75rem); cursor: pointer;
    display: flex; align-items: center; justify-content: center; transition: all 0.15s;
  }
  .trigger-btn:active { background: rgba(76,153,76,0.3); border-color: rgba(76,153,76,0.7); transform: scale(0.95); }
  .trigger-btn.invite-glow { border-color: rgba(76,153,76,0.6); background: rgba(76,153,76,0.15); box-shadow: 0 0 12px rgba(76,153,76,0.15); }

  /* ═══════════════════════════════════
     WATER
     ═══════════════════════════════════ */
  #water-page { background: radial-gradient(ellipse at 50% 40%, #0a1220 0%, #060a10 100%); }
  #water-page .bg-char { color: var(--water); }
  .water-tilt-hint {
    margin-bottom: clamp(12px, 2vh, 20px);
    opacity: 0.35; animation: tiltCueAnim 3s ease-in-out infinite;
  }
  .water-tilt-hint svg { width: 56px; height: 56px; }
  @keyframes tiltCueAnim {
    0%, 100% { transform: rotate(0deg); } 20% { transform: rotate(18deg); }
    40% { transform: rotate(-3deg); } 60% { transform: rotate(-18deg); }
    80% { transform: rotate(3deg); }
  }
  .spirit-level {
    width: clamp(200px, 55vw, 260px); height: clamp(200px, 55vw, 260px);
    border-radius: 50%; border: 1px solid rgba(70,130,200,0.15);
    position: relative; overflow: hidden; background: transparent;
  }
  .spirit-level::before {
    content: ''; position: absolute; top: 50%; left: 10%; right: 10%; height: 1px;
    background: rgba(70,130,200,0.12);
  }
  .spirit-level::after {
    content: ''; position: absolute; left: 50%; top: 10%; bottom: 10%; width: 1px;
    background: rgba(70,130,200,0.12);
  }
  .spirit-target {
    position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
    width: 40px; height: 40px; border: 1px solid rgba(70,130,200,0.15);
    border-radius: 50%; pointer-events: none;
  }
  .spirit-target-outer {
    position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
    width: 80px; height: 80px; border: 1px solid rgba(70,130,200,0.08);
    border-radius: 50%; pointer-events: none;
  }
  .spirit-bubble {
    position: absolute; width: 36px; height: 36px; border-radius: 50%;
    top: 50%; left: 50%; transform: translate(-50%, -50%);
    transition: left 0.12s ease-out, top 0.12s ease-out;
    pointer-events: none; z-index: 5;
  }
  .spirit-bubble-inner {
    width: 100%; height: 100%; border-radius: 50%;
    background: radial-gradient(circle at 35% 35%,
      rgba(130,185,240,0.5) 0%, rgba(70,130,200,0.3) 40%,
      rgba(50,100,180,0.15) 70%, rgba(40,80,160,0.05) 100%);
    box-shadow: 0 0 15px rgba(70,130,200,0.25), inset 0 0 8px rgba(130,185,240,0.2);
    position: relative;
  }
  .spirit-bubble-inner::before {
    content: ''; position: absolute; top: 20%; left: 25%;
    width: 35%; height: 25%; border-radius: 50%;
    background: rgba(200,225,255,0.3); filter: blur(2px);
  }
  .water-tilt-readout {
    position: absolute; bottom: calc(80px + var(--safe-bottom));
    left: 0; right: 0; z-index: 20;
    display: flex; justify-content: center;
    gap: clamp(16px, 5vw, 30px); pointer-events: none;
    transition: opacity 0.5s ease;
  }
  .tilt-axis { display: flex; flex-direction: column; align-items: center; gap: 2px; }
  .tilt-axis .tilt-label {
    font-family: 'Cormorant Garamond', serif;
    font-size: clamp(0.6rem, 2.5vw, 0.75rem); font-weight: 300;
    font-style: italic; opacity: 0.4; text-transform: uppercase; letter-spacing: 0.1em;
  }
  .tilt-axis .tilt-value {
    font-family: 'Noto Serif SC', serif;
    font-size: clamp(1.8rem, 8vw, 2.8rem); font-weight: 300;
    color: rgba(255,255,255,0.7); line-height: 1;
  }

  /* ═══════════════════════════════════
     FIRE
     ═══════════════════════════════════ */
  #fire-page { background: radial-gradient(ellipse at 50% 60%, #1a0a08 0%, #0d0604 100%); }
  #fire-page .bg-char { color: var(--fire); }
  .fire-swipe-area {
    width: min(88vw, 320px); flex: 1; max-height: 42vh;
    border: 1px solid rgba(220,60,40,0.15); border-radius: 16px;
    position: relative; overflow: hidden; touch-action: none;
  }
  .flame-particle { position: absolute; border-radius: 50%; pointer-events: none; animation: flameRise 0.8s ease-out forwards; }
  @keyframes flameRise { 0% { opacity: 1; transform: scale(1) translateY(0); } 100% { opacity: 0; transform: scale(0.2) translateY(-80px); } }
  .fire-xy-container { margin-bottom: clamp(8px, 2vh, 16px); }
  .fire-ghost { animation: fireGhostMove 3s ease-in-out infinite; }
  @keyframes fireGhostMove {
    0% { left: 50%; top: 50%; } 20% { left: 30%; top: 30%; }
    40% { left: 70%; top: 40%; } 60% { left: 60%; top: 70%; }
    80% { left: 35%; top: 55%; } 100% { left: 50%; top: 50%; }
  }
  .swipe-ghost {
    position: absolute; width: 16px; height: 16px; border-radius: 50%;
    background: rgba(220,60,40,0.25); pointer-events: none;
    animation: swipeGhostMove 2.5s ease-in-out infinite; transition: opacity 0.5s ease;
  }
  .swipe-ghost::after {
    content: ''; position: absolute; width: 10px; height: 10px;
    border-radius: 50%; background: rgba(220,60,40,0.15);
    top: -14px; left: 3px; animation: swipeTrail 2.5s ease-in-out infinite;
  }
  @keyframes swipeGhostMove {
    0% { left: 20%; top: 70%; opacity: 0; } 10% { opacity: 0.6; }
    50% { left: 75%; top: 30%; opacity: 0.6; } 60% { opacity: 0; }
    100% { left: 20%; top: 70%; opacity: 0; }
  }
  @keyframes swipeTrail { 0% { opacity: 0; } 15% { opacity: 0.5; } 45% { opacity: 0.5; } 55% { opacity: 0; } 100% { opacity: 0; } }

  /* ═══════════════════════════════════
     EARTH
     ═══════════════════════════════════ */
  #earth-page { background: radial-gradient(ellipse at 50% 50%, #1a1008 0%, #0d0904 100%); }
  #earth-page .bg-char { color: var(--earth); }
  .earth-touch-area {
    width: clamp(160px, 42vw, 210px); height: clamp(160px, 42vw, 210px);
    border: 2px solid rgba(139,94,60,0.25); border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    cursor: pointer; position: relative;
  }
  .earth-thumbprint {
    opacity: 0.35; transition: opacity 0.4s ease;
    animation: thumbPulse 2.5s ease-in-out infinite;
  }
  .earth-thumbprint svg { width: clamp(56px, 16vw, 72px); height: clamp(70px, 20vw, 90px); }
  @keyframes thumbPulse {
    0%, 100% { transform: scale(1); opacity: 0.35; }
    50% { transform: scale(1.06); opacity: 0.5; }
  }
  .earth-pulse {
    position: absolute; border: 1px solid rgba(139,94,60,0.3);
    border-radius: 50%; animation: earthPulse 1s ease-out forwards; pointer-events: none;
  }
  @keyframes earthPulse { 0% { transform: scale(1); opacity: 0.5; } 100% { transform: scale(2); opacity: 0; } }
  @keyframes screenShake {
    0%, 100% { transform: translate(0,0); }
    10% { transform: translate(-5px,-3px); } 20% { transform: translate(5px,3px); }
    30% { transform: translate(-4px,4px); } 40% { transform: translate(4px,-4px); }
    50% { transform: translate(-3px,2px); } 60% { transform: translate(3px,-2px); }
    70% { transform: translate(-2px,3px); } 80% { transform: translate(2px,-1px); }
    90% { transform: translate(-1px,1px); }
  }

  @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
</style>
</head>
<body>

<!-- Permission -->
<div class="permission-overlay" id="permissionOverlay">
  <h2>五行</h2>
  <p>This experience uses your device's<br>motion sensors, audio, and haptics.</p>
  <div class="setup-hint">unmute · volume up · brightness up</div>
  <button class="permission-btn" id="startBtn">Enter</button>
  <div class="permission-status" id="permStatus"></div>
</div>

<!-- Landing -->
<div id="landing">
  <div class="circle-layout" id="circleLayout">
    <div class="circle-ring"></div>
    <canvas class="energy-canvas" id="energyCanvas"></canvas>
    <div class="circle-el c-metal" id="el-metal" onclick="openElement('metal')"><span class="char">金</span><span class="elname">Metal</span></div>
    <div class="circle-el c-wood" id="el-wood" onclick="openElement('wood')"><span class="char">木</span><span class="elname">Wood</span></div>
    <div class="circle-el c-water" id="el-water" onclick="openElement('water')"><span class="char">水</span><span class="elname">Water</span></div>
    <div class="circle-el c-fire" id="el-fire" onclick="openElement('fire')"><span class="char">火</span><span class="elname">Fire</span></div>
    <div class="circle-el c-earth" id="el-earth" onclick="openElement('earth')"><span class="char">土</span><span class="elname">Earth</span></div>
    <div class="circle-center" id="circleCenter" onclick="cycleLandingState()">
      <h1 id="centerTitle">五行</h1>
      <div class="subtitle" id="centerSub">Five Elements</div>
    </div>
  </div>
</div>

<!-- Metal -->
<div class="element-page" id="metal-page">
  <button class="home-btn" onclick="goHome()">⌂</button>
  <div class="bg-char">金</div>
  <div class="interaction-area">
    <div class="metal-ring-visual" id="metalRing">
      <div class="metal-shake-icon cue-visible" id="metalCue">
        <svg viewBox="0 0 40 40" fill="none" stroke="rgba(255,255,255,0.7)" stroke-width="1.5" stroke-linecap="round">
          <rect x="13" y="7" width="14" height="26" rx="3"/>
          <line x1="5" y1="13" x2="9" y2="10"/><line x1="4" y1="20" x2="9" y2="20"/>
          <line x1="5" y1="27" x2="9" y2="30"/><line x1="35" y1="13" x2="31" y2="10"/>
          <line x1="36" y1="20" x2="31" y2="20"/><line x1="35" y1="27" x2="31" y2="30"/>
        </svg>
      </div>
    </div>
  </div>
</div>

<!-- Wood -->
<div class="element-page" id="wood-page">
  <button class="home-btn" onclick="goHome()">⌂</button>
  <div class="bg-char">木</div>
  <div class="interaction-area">
    <div class="xy-pad" id="woodPad">
      <div class="crosshair" id="woodCrosshair"></div>
      <div class="ghost-cursor wood-ghost" id="woodGhost"></div>
    </div>
    <div class="trigger-grid">
      <button class="trigger-btn" data-note="0">C</button>
      <button class="trigger-btn" data-note="1">D♭</button>
      <button class="trigger-btn" data-note="2">F</button>
      <button class="trigger-btn" data-note="3">G</button>
      <button class="trigger-btn" data-note="4">A♭</button>
      <button class="trigger-btn" data-note="5">WB</button>
    </div>
  </div>
</div>

<!-- Water -->
<div class="element-page" id="water-page">
  <button class="home-btn" onclick="goHome()">⌂</button>
  <div class="bg-char">水</div>
  <div class="interaction-area">
    <div class="water-tilt-hint">
      <svg viewBox="0 0 48 48" fill="none" stroke-linecap="round">
        <rect x="16" y="10" width="16" height="26" rx="3" stroke="rgba(255,255,255,0.7)" stroke-width="1.5"/>
        <path d="M8 23 L3 23" stroke="rgba(255,255,255,0.45)" stroke-width="1.2"/>
        <path d="M6 19.5 L3 23 L6 26.5" stroke="rgba(255,255,255,0.45)" stroke-width="1.2" fill="none"/>
        <path d="M40 23 L45 23" stroke="rgba(255,255,255,0.45)" stroke-width="1.2"/>
        <path d="M42 19.5 L45 23 L42 26.5" stroke="rgba(255,255,255,0.45)" stroke-width="1.2" fill="none"/>
        <path d="M24 5 L24 1" stroke="rgba(255,255,255,0.45)" stroke-width="1.2"/>
        <path d="M20.5 3.5 L24 0.5 L27.5 3.5" stroke="rgba(255,255,255,0.45)" stroke-width="1.2" fill="none"/>
        <path d="M24 43 L24 47" stroke="rgba(255,255,255,0.45)" stroke-width="1.2"/>
        <path d="M20.5 44.5 L24 47.5 L27.5 44.5" stroke="rgba(255,255,255,0.45)" stroke-width="1.2" fill="none"/>
      </svg>
    </div>
    <div class="spirit-level" id="spiritLevel">
      <div class="spirit-target-outer"></div>
      <div class="spirit-target"></div>
      <div class="spirit-bubble" id="spiritBubble"><div class="spirit-bubble-inner"></div></div>
    </div>
    <div class="water-tilt-readout" id="waterReadout" style="opacity:0;">
      <div class="tilt-axis"><span class="tilt-label">Tilt</span><span class="tilt-value" id="tiltBeta">0°</span></div>
      <div class="tilt-axis"><span class="tilt-label">Roll</span><span class="tilt-value" id="tiltGamma">0°</span></div>
      <div class="tilt-axis"><span class="tilt-label">Spin</span><span class="tilt-value" id="tiltAlpha">0°</span></div>
    </div>
  </div>
</div>

<!-- Fire -->
<div class="element-page" id="fire-page">
  <button class="home-btn" onclick="goHome()">⌂</button>
  <div class="bg-char">火</div>
  <div class="interaction-area">
    <div class="fire-xy-container">
      <div class="xy-pad" id="firePad" style="border-color:rgba(220,60,40,0.15);max-width:200px;">
        <div class="crosshair" id="fireCrosshair"></div>
        <div class="ghost-cursor fire-ghost" id="fireGhost"></div>
      </div>
    </div>
    <div class="fire-swipe-area" id="fireSwipeArea">
      <div class="swipe-ghost" id="fireSwipeGhost"></div>
    </div>
  </div>
</div>

<!-- Earth -->
<div class="element-page" id="earth-page">
  <button class="home-btn" onclick="goHome()">⌂</button>
  <div class="bg-char">土</div>
  <div class="interaction-area">
    <div class="earth-touch-area" id="earthTouch">
      <div class="earth-thumbprint" id="earthCue">
        <svg viewBox="0 0 64 80" fill="none" stroke="rgba(255,255,255,0.55)" stroke-width="1.1" stroke-linecap="round">
          <path d="M18 70 C12 62 10 52 10 42 C10 22 18 10 32 8 C46 10 54 22 54 42 C54 52 52 62 46 70" stroke="rgba(255,255,255,0.25)" stroke-width="1.5"/>
          <path d="M20 60 C24 54 28 52 32 52 C36 52 40 54 44 60"/>
          <path d="M18 56 C23 48 27 46 32 46 C37 46 41 48 46 56"/>
          <path d="M17 51 C22 43 27 40 32 40 C37 40 42 43 47 51"/>
          <path d="M17 46 C22 38 27 35 32 35 C37 35 42 38 47 46"/>
          <path d="M24 40 C24 34 27 30 32 30 C37 30 40 34 40 40 C40 44 37 47 32 47 C27 47 24 44 24 40"/>
          <path d="M27 39 C27 36 29 33 32 33 C35 33 37 36 37 39 C37 42 35 44 32 44 C29 44 27 42 27 39"/>
          <path d="M18 40 C20 30 25 24 32 24 C39 24 44 30 46 40"/>
          <path d="M16 36 C19 24 25 18 32 18 C39 18 45 24 48 36"/>
          <path d="M15 32 C18 20 24 14 32 14 C40 14 46 20 49 32"/>
          <path d="M16 28 C19 18 24 12 32 12 C40 12 45 18 48 28"/>
          <path d="M32 68 L32 76" stroke="rgba(255,255,255,0.3)" stroke-width="1.3"/>
          <path d="M28 73 L32 77 L36 73" stroke="rgba(255,255,255,0.3)" stroke-width="1.3" fill="none"/>
        </svg>
      </div>
    </div>
  </div>
</div>

<!-- Nav -->
<div class="bottom-nav" id="bottomNav" style="display:none;">
  <button class="nav-item metal" onclick="switchElement('metal')"><span>金</span><span class="nav-label">Metal</span></button>
  <button class="nav-item wood" onclick="switchElement('wood')"><span>木</span><span class="nav-label">Wood</span></button>
  <button class="nav-item water" onclick="switchElement('water')"><span>水</span><span class="nav-label">Water</span></button>
  <button class="nav-item fire" onclick="switchElement('fire')"><span>火</span><span class="nav-label">Fire</span></button>
  <button class="nav-item earth" onclick="switchElement('earth')"><span>土</span><span class="nav-label">Earth</span></button>
</div>

<script>
// ═══════════════════════════════════
// AUDIO LOADING
// ═══════════════════════════════════
let audioCtx=null,currentElement=null;
const audioBuffers={};
const AUDIO_FILES={
  'water_long':'audio/Water_Long.mp3',
  'wood_long':'audio/Wood_Long.mp3',
  'fire_long':'audio/Fire_Long.mp3',
  'earth_long':'audio/Earth_Long.mp3',
  'C2':'audio/C2_Marimba_Hard.mp3','C3':'audio/C3_Marimba_Hard.mp3',
  'C4':'audio/C4_Marimba_Hard.mp3','C5':'audio/C5_Marimba_Hard.mp3','C6':'audio/C6_Marimba_Hard.mp3',
  'Db2':'audio/Db2_Marimba_Hard.mp3','Db3':'audio/Db3_Marimba_Hard.mp3',
  'Db4':'audio/Db4_Marimba_Hard.mp3','Db5':'audio/Db5_Marimba_Hard.mp3',
  'F2':'audio/F2_Marimba_Hard.mp3','F3':'audio/F3_Marimba_Hard.mp3',
  'F4':'audio/F4_Marimba_Hard.mp3','F5':'audio/F5_Marimba_Hard.mp3',
  'G2':'audio/G2_Marimba_Hard.mp3','G3':'audio/G3_Marimba_Hard.mp3',
  'G4':'audio/G4_Marimba_Hard.mp3','G5':'audio/G5_Marimba_Hard.mp3',
  'Ab2':'audio/Ab2_Marimba_Hard.mp3','Ab3':'audio/Ab3_Marimba_Hard.mp3',
  'Ab4':'audio/Ab4_Marimba_Hard.mp3','Ab5':'audio/Ab5_Marimba_Hard.mp3',
  'Wb1':'audio/Wb1.mp3','Wb2':'audio/Wb2.mp3','Wb3':'audio/Wb3.mp3','Wb4':'audio/Wb4.mp3'
};

async function loadAllAudio(){
  if(!audioCtx)return;
  const promises=Object.entries(AUDIO_FILES).map(async([k,url])=>{
    try{
      const r=await fetch(url);
      const ab=await r.arrayBuffer();
      audioBuffers[k]=await audioCtx.decodeAudioData(ab);
    }catch(e){console.warn('Failed to load '+url,e);}
  });
  await Promise.all(promises);
}

function initAudio(){
  if(!audioCtx)audioCtx=new(window.AudioContext||window.webkitAudioContext)();
  if(audioCtx.state==='suspended')audioCtx.resume();
}

function playBuffer(key,loop,gain){
  const buf=audioBuffers[key];if(!buf)return null;
  const src=audioCtx.createBufferSource();
  const g=audioCtx.createGain();
  src.buffer=buf;src.loop=!!loop;
  g.gain.value=gain||1;
  src.connect(g);g.connect(audioCtx.destination);
  src.start();
  return{source:src,gain:g};
}

function playBufferWithChain(key,loop){
  const buf=audioBuffers[key];if(!buf)return null;
  const src=audioCtx.createBufferSource();
  const g=audioCtx.createGain();
  const fl=audioCtx.createBiquadFilter();
  fl.type='lowpass';fl.frequency.value=800;fl.Q.value=2;
  g.gain.value=0;
  src.buffer=buf;src.loop=!!loop;
  src.connect(fl);fl.connect(g);g.connect(audioCtx.destination);
  src.start();
  return{source:src,gain:g,filter:fl};
}

document.getElementById('startBtn').addEventListener('click',async()=>{
  const s=document.getElementById('permStatus');s.textContent='Loading…';
  initAudio();
  if(typeof DeviceMotionEvent!=='undefined'&&typeof DeviceMotionEvent.requestPermission==='function'){try{await DeviceMotionEvent.requestPermission();}catch(e){}}
  if(typeof DeviceOrientationEvent!=='undefined'&&typeof DeviceOrientationEvent.requestPermission==='function'){try{await DeviceOrientationEvent.requestPermission();}catch(e){}}
  if(navigator.vibrate)navigator.vibrate(1);
  if('wakeLock' in navigator){try{await navigator.wakeLock.request('screen');}catch(e){}}
  await loadAllAudio();
  document.getElementById('permissionOverlay').classList.add('hidden');
  initLanding();
});

function hideCue(id){const c=document.getElementById(id);if(c){c.classList.remove('cue-visible');c.classList.add('cue-hidden');}}
function showCue(id){const c=document.getElementById(id);if(c){c.classList.remove('cue-hidden');c.classList.add('cue-visible');}}

// ═══════════════════════════════════
// LANDING
// ═══════════════════════════════════
const PPOS=[{top:7.5,left:50},{top:34.5,left:90},{top:84,left:74},{top:84,left:26},{top:34.5,left:10}];
const EL_IDS=['el-metal','el-wood','el-water','el-fire','el-earth'];
const STATE_MAP={
  wuxing:[0,1,2,3,4],
  sheng: [0,2,1,3,4],
  ke:    [0,4,2,1,3]
};
const STATE_LABELS={
  wuxing:{title:'五行',sub:'Five Elements'},
  sheng: {title:'生',sub:'Creation'},
  ke:    {title:'克',sub:'Destruction'}
};
const STATE_ORDER=['wuxing','sheng','ke'];
let landingState='wuxing',energyAnimFrame=null,energyParticles=[],energyDirection=0;

function initLanding(){
  const layout=document.getElementById('circleLayout');
  const canvas=document.getElementById('energyCanvas');
  const sz=layout.clientWidth;
  canvas.width=sz*2;canvas.height=sz*2;
  canvas.style.width=sz+'px';canvas.style.height=sz+'px';
  setElementPositions('wuxing');
}
function setElementPositions(state){
  const map=STATE_MAP[state];
  for(let i=0;i<5;i++){
    const el=document.getElementById(EL_IDS[i]);
    const p=PPOS[map[i]];
    el.style.top=p.top+'%';el.style.left=p.left+'%';
  }
}
function cycleLandingState(){
  stopEnergyFlow();
  const next=STATE_ORDER[(STATE_ORDER.indexOf(landingState)+1)%3];
  landingState=next;
  document.getElementById('centerTitle').textContent=STATE_LABELS[next].title;
  document.getElementById('centerSub').textContent=STATE_LABELS[next].sub;
  setElementPositions(next);
  if(next!=='wuxing')setTimeout(()=>startEnergyFlow(next==='sheng'?1:-1),750);
}
function startEnergyFlow(dir){
  energyDirection=dir;energyParticles=[];
  for(let i=0;i<6;i++)energyParticles.push({angle:(i/6)*Math.PI*2,speed:0.012+Math.random()*0.004,size:2+Math.random()*1.5});
  drawEnergy();
}
function stopEnergyFlow(){
  if(energyAnimFrame){cancelAnimationFrame(energyAnimFrame);energyAnimFrame=null;}
  const canvas=document.getElementById('energyCanvas');
  if(canvas){canvas.getContext('2d').clearRect(0,0,canvas.width,canvas.height);}
}
function drawEnergy(){
  const canvas=document.getElementById('energyCanvas');
  const ctx=canvas.getContext('2d'),w=canvas.width,h=canvas.height,cx=w/2,cy=h/2,r=w*0.425;
  ctx.clearRect(0,0,w,h);
  for(const p of energyParticles){
    p.angle+=p.speed*energyDirection;
    const x=cx+r*Math.sin(p.angle),y=cy-r*Math.cos(p.angle);
    const g=ctx.createRadialGradient(x,y,0,x,y,16);
    g.addColorStop(0,'rgba(255,255,255,0.4)');g.addColorStop(0.4,'rgba(255,255,255,0.1)');g.addColorStop(1,'rgba(255,255,255,0)');
    ctx.fillStyle=g;ctx.beginPath();ctx.arc(x,y,16,0,Math.PI*2);ctx.fill();
    ctx.fillStyle='rgba(255,255,255,0.7)';ctx.beginPath();ctx.arc(x,y,p.size,0,Math.PI*2);ctx.fill();
    for(let t=1;t<=3;t++){
      const ta=p.angle-p.speed*energyDirection*t*3,tx=cx+r*Math.sin(ta),ty=cy-r*Math.cos(ta);
      ctx.fillStyle=`rgba(255,255,255,${0.2-t*0.06})`;ctx.beginPath();ctx.arc(tx,ty,p.size*0.7,0,Math.PI*2);ctx.fill();
    }
  }
  energyAnimFrame=requestAnimationFrame(drawEnergy);
}

// ═══════════════════════════════════
// NAV
// ═══════════════════════════════════
function openElement(n){initAudio();stopEnergyFlow();document.getElementById('landing').style.display='none';document.getElementById('bottomNav').style.display='flex';switchElement(n);}
function switchElement(n){
  if(currentElement===n)return;
  if(currentElement)cleanupCurrent();
  document.querySelectorAll('.element-page').forEach(p=>p.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(i=>i.classList.remove('active'));
  document.querySelector(`.nav-item.${n}`).classList.add('active');
  document.getElementById(n+'-page').classList.add('active');
  currentElement=n;initAudio();
  ({metal:initMetal,wood:initWood,water:initWater,fire:initFire,earth:initEarth})[n]();
}
function goHome(){
  cleanupCurrent();
  document.querySelectorAll('.element-page').forEach(p=>p.classList.remove('active'));
  document.getElementById('bottomNav').style.display='none';
  document.getElementById('landing').style.display='flex';
  currentElement=null;initLanding();
  if(landingState!=='wuxing')setTimeout(()=>startEnergyFlow(landingState==='sheng'?1:-1),100);
}
function cleanupCurrent(){({metal:cleanupMetal,wood:cleanupWood,water:cleanupWater,fire:cleanupFire,earth:cleanupEarth})[currentElement]();}

// ═══════════════════════════════════
// METAL — synth, 1s idle
// ═══════════════════════════════════
let metalHandler=null,metalLastShake=0,metalIdleTimer=null;
function initMetal(){
  showCue('metalCue');
  metalHandler=e=>{
    const a=e.accelerationIncludingGravity||e.acceleration;if(!a)return;
    const m=Math.sqrt(a.x*a.x+a.y*a.y+a.z*a.z),now=Date.now();
    if(m>18&&now-metalLastShake>120){
      metalLastShake=now;hideCue('metalCue');triggerMetalRing(Math.min(m/40,1));
      clearTimeout(metalIdleTimer);metalIdleTimer=setTimeout(()=>showCue('metalCue'),1000);
    }
  };
  window.addEventListener('devicemotion',metalHandler);
  document.getElementById('metalRing').addEventListener('touchstart',metalTap);
}
function metalTap(){hideCue('metalCue');triggerMetalRing(0.7);clearTimeout(metalIdleTimer);metalIdleTimer=setTimeout(()=>showCue('metalCue'),1000);}
function triggerMetalRing(v){
  const r=document.getElementById('metalRing');r.classList.add('shaking');setTimeout(()=>r.classList.remove('shaking'),200);
  const t=audioCtx.currentTime,f=800+Math.random()*600;
  const m=audioCtx.createOscillator(),mg=audioCtx.createGain(),c=audioCtx.createOscillator(),e=audioCtx.createGain();
  m.frequency.value=f*1.4;mg.gain.value=f*2;c.frequency.value=f;
  m.connect(mg);mg.connect(c.frequency);c.connect(e);e.connect(audioCtx.destination);
  e.gain.setValueAtTime(v*0.25,t);e.gain.exponentialRampToValueAtTime(0.001,t+1.5);
  m.start(t);c.start(t);m.stop(t+1.6);c.stop(t+1.6);
}
function cleanupMetal(){
  if(metalHandler)window.removeEventListener('devicemotion',metalHandler);
  document.getElementById('metalRing').removeEventListener('touchstart',metalTap);
  clearTimeout(metalIdleTimer);metalHandler=null;
}

// ═══════════════════════════════════
// WOOD — MP3 XY pad + marimba/WB samples
// ═══════════════════════════════════
let woodLoop=null,woodPadActive=false,woodGlowInterval=null;

// Round robin config: [samples[], defaultKey, defaultCount]
const WOOD_NOTES=[
  {keys:['C2','C3','C4','C5','C6'], def:'C3', defCount:2},
  {keys:['Db2','Db3','Db4','Db5'], def:'Db3', defCount:2},
  {keys:['F2','F3','F4','F5'], def:'F3', defCount:2},
  {keys:['G2','G3','G4','G5'], def:'G3', defCount:2},
  {keys:['Ab2','Ab3','Ab4','Ab5'], def:'Ab3', defCount:2},
  {keys:['Wb1','Wb2','Wb3','Wb4'], def:'Wb3', defCount:1}
];
let woodTapCounts=[0,0,0,0,0,0];

function initWood(){
  woodTapCounts=[0,0,0,0,0,0];

  // XY pad with MP3 loop
  woodLoop=playBufferWithChain('wood_long',true);
  if(woodLoop){woodLoop.filter.frequency.value=300;woodLoop.gain.gain.value=0;}

  const pad=document.getElementById('woodPad'),cross=document.getElementById('woodCrosshair'),ghost=document.getElementById('woodGhost');
  ghost.style.opacity='1';

  const mv=(x,y)=>{
    const r=pad.getBoundingClientRect();
    const nx=Math.max(0,Math.min(1,(x-r.left)/r.width)),ny=Math.max(0,Math.min(1,(y-r.top)/r.height));
    cross.style.left=(nx*100)+'%';cross.style.top=(ny*100)+'%';
    // Log filter: 200Hz to 4000Hz
    const logFreq=200*Math.pow(20,nx);
    // Log volume with floor
    const vol=Math.max(0.05,Math.pow(1-ny,2)*0.35);
    if(woodLoop){
      woodLoop.filter.frequency.setTargetAtTime(logFreq,audioCtx.currentTime,0.05);
      woodLoop.gain.gain.setTargetAtTime(vol,audioCtx.currentTime,0.05);
    }
  };
  pad.addEventListener('touchstart',e=>{e.preventDefault();woodPadActive=true;ghost.style.opacity='0';mv(e.touches[0].clientX,e.touches[0].clientY);});
  pad.addEventListener('touchmove',e=>{e.preventDefault();if(woodPadActive)mv(e.touches[0].clientX,e.touches[0].clientY);});
  pad.addEventListener('touchend',()=>{
    woodPadActive=false;cross.style.left='50%';cross.style.top='50%';
    if(woodLoop)woodLoop.gain.gain.linearRampToValueAtTime(0,audioCtx.currentTime+0.3);
  });

  // Trigger buttons glow
  const btns=document.querySelectorAll('#wood-page .trigger-btn');let gi=0;
  woodGlowInterval=setInterval(()=>{btns.forEach(b=>b.classList.remove('invite-glow'));btns[gi].classList.add('invite-glow');gi=(gi+1)%btns.length;},600);

  btns.forEach((b,i)=>{
    b.addEventListener('touchstart',e=>{
      e.preventDefault();
      if(woodGlowInterval){clearInterval(woodGlowInterval);woodGlowInterval=null;btns.forEach(bb=>bb.classList.remove('invite-glow'));}
      triggerWoodSample(i);
    });
  });
}

function triggerWoodSample(idx){
  const note=WOOD_NOTES[idx];
  const count=woodTapCounts[idx];
  let key;
  if(count<note.defCount){
    key=note.def;
  }else{
    key=note.keys[Math.floor(Math.random()*note.keys.length)];
  }
  woodTapCounts[idx]++;
  playBuffer(key,false,0.5);
}

function cleanupWood(){
  if(woodLoop){
    woodLoop.gain.gain.linearRampToValueAtTime(0,audioCtx.currentTime+0.15);
    setTimeout(()=>{try{woodLoop.source.stop();}catch(e){}woodLoop=null;},200);
  }else{woodLoop=null;}
  if(woodGlowInterval){clearInterval(woodGlowInterval);woodGlowInterval=null;}
  document.querySelectorAll('#wood-page .trigger-btn').forEach(b=>b.classList.remove('invite-glow'));
}

// ═══════════════════════════════════
// WATER — MP3 loop, clamped tilt
// ═══════════════════════════════════
let waterLoop=null,waterSynth=null,waterLfo=null,waterLfoGain=null,waterOrientHandler=null,waterReady=false,waterDelayTimer=null,waterBaseAlpha=null;
const BETA_NEUTRAL=60,TILT_CLAMP=50,ROLL_CLAMP=50,SPIN_CLAMP=60;

function initWater(){
  waterReady=false;waterBaseAlpha=null;
  document.getElementById('waterReadout').style.opacity='0';
  const bubble=document.getElementById('spiritBubble');
  bubble.style.left='50%';bubble.style.top='50%';

  // MP3 loop through filter
  waterLoop=playBufferWithChain('water_long',true);
  if(waterLoop){
    waterLoop.gain.gain.value=0;
    waterLoop.filter.frequency.value=800;
    // LFO on filter
    waterLfo=audioCtx.createOscillator();
    waterLfoGain=audioCtx.createGain();
    waterLfo.type='sine';waterLfo.frequency.value=0.3;
    waterLfoGain.gain.value=200;
    waterLfo.connect(waterLfoGain);
    waterLfoGain.connect(waterLoop.filter.frequency);
    waterLfo.start();
  }

  // Triangle wave synth bed (very quiet)
  waterSynth=createDrone(80,'triangle',3);
  waterSynth.filter.frequency.value=800;waterSynth.gain.gain.value=0;

  const readout=document.getElementById('waterReadout');
  const vB=document.getElementById('tiltBeta'),vG=document.getElementById('tiltGamma'),vA=document.getElementById('tiltAlpha');
  const level=document.getElementById('spiritLevel');

  waterDelayTimer=setTimeout(()=>{
    waterReady=true;
    if(waterLoop){
      waterLoop.gain.gain.setValueAtTime(0,audioCtx.currentTime);
      waterLoop.gain.gain.linearRampToValueAtTime(0.35,audioCtx.currentTime+2.0);
    }
    if(waterSynth){
      waterSynth.gain.gain.setValueAtTime(0,audioCtx.currentTime);
      waterSynth.gain.gain.linearRampToValueAtTime(0.06,audioCtx.currentTime+2.0);
    }
    readout.style.opacity='1';
  },1000);

  waterOrientHandler=e=>{
    const beta=e.beta||0,gamma=e.gamma||0,alpha=e.alpha||0;
    if(waterBaseAlpha===null)waterBaseAlpha=alpha;

    const relBeta=beta-BETA_NEUTRAL,relGamma=gamma;
    let relAlpha=alpha-waterBaseAlpha;
    if(relAlpha>180)relAlpha-=360;
    if(relAlpha<-180)relAlpha+=360;

    const cB=Math.max(-TILT_CLAMP,Math.min(TILT_CLAMP,relBeta));
    const cG=Math.max(-ROLL_CLAMP,Math.min(ROLL_CLAMP,relGamma));
    const cA=Math.max(-SPIN_CLAMP,Math.min(SPIN_CLAMP,relAlpha));

    const nx=(cG+ROLL_CLAMP)/(ROLL_CLAMP*2);
    const ny=(cB+TILT_CLAMP)/(TILT_CLAMP*2);
    const nz=(cA+SPIN_CLAMP)/(SPIN_CLAMP*2);

    vB.textContent=Math.round(cB)+'°';
    vG.textContent=Math.round(cG)+'°';
    vA.textContent=Math.round(cA)+'°';

    const bx=50+(cG/ROLL_CLAMP)*38,by=50+(cB/TILT_CLAMP)*38;
    bubble.style.left=bx+'%';bubble.style.top=by+'%';

    if(!waterReady||!waterLoop)return;
    // Roll → playback rate (0.5 to 2.0)
    waterLoop.source.playbackRate.setTargetAtTime(0.5+nx*1.5,audioCtx.currentTime,0.1);
    // Tilt → filter cutoff
    waterLoop.filter.frequency.setTargetAtTime(200+ny*4000,audioCtx.currentTime,0.1);
    // Spin → LFO speed
    if(waterLfo)waterLfo.frequency.setTargetAtTime(0.1+nz*6,audioCtx.currentTime,0.1);
    // Synth bed follows filter
    if(waterSynth)waterSynth.filter.frequency.setTargetAtTime(200+ny*4000,audioCtx.currentTime,0.1);
  };
  window.addEventListener('deviceorientation',waterOrientHandler);

  // Touch fallback
  level.addEventListener('touchmove',e=>{
    e.preventDefault();
    const r=level.getBoundingClientRect(),t=e.touches[0];
    const nx=Math.max(0,Math.min(1,(t.clientX-r.left)/r.width)),ny=Math.max(0,Math.min(1,(t.clientY-r.top)/r.height));
    bubble.style.left=(nx*100)+'%';bubble.style.top=(ny*100)+'%';
    vB.textContent=Math.round((ny-0.5)*TILT_CLAMP*2)+'°';
    vG.textContent=Math.round((nx-0.5)*ROLL_CLAMP*2)+'°';
    if(!waterReady||!waterLoop)return;
    waterLoop.source.playbackRate.setTargetAtTime(0.5+nx*1.5,audioCtx.currentTime,0.1);
    waterLoop.filter.frequency.setTargetAtTime(200+ny*4000,audioCtx.currentTime,0.1);
  });
}

function cleanupWater(){
  if(waterOrientHandler)window.removeEventListener('deviceorientation',waterOrientHandler);
  waterOrientHandler=null;waterReady=false;waterBaseAlpha=null;
  clearTimeout(waterDelayTimer);
  document.getElementById('waterReadout').style.opacity='0';
  if(waterLoop){
    waterLoop.gain.gain.linearRampToValueAtTime(0,audioCtx.currentTime+0.3);
    if(waterLfo)try{waterLfo.stop();}catch(e){}
    setTimeout(()=>{try{waterLoop.source.stop();}catch(e){}waterLoop=null;waterLfo=null;waterLfoGain=null;},350);
  }else{waterLoop=null;waterLfo=null;waterLfoGain=null;}
  if(waterSynth){
    waterSynth.gain.gain.linearRampToValueAtTime(0,audioCtx.currentTime+0.3);
    setTimeout(()=>{try{waterSynth.osc1.stop();waterSynth.osc2.stop();}catch(e){}waterSynth=null;},350);
  }else{waterSynth=null;}
}

// ═══════════════════════════════════
// FIRE — MP3 XY pad + synth swipe
// ═══════════════════════════════════
let fireLoop=null,firePadActive=false,fireLastSwipe=0;
function initFire(){
  fireLoop=playBufferWithChain('fire_long',true);
  if(fireLoop){fireLoop.filter.frequency.value=400;fireLoop.gain.gain.value=0;}

  const pad=document.getElementById('firePad'),cross=document.getElementById('fireCrosshair');
  const ghost=document.getElementById('fireGhost'),swipeGhost=document.getElementById('fireSwipeGhost');
  ghost.style.opacity='1';swipeGhost.style.opacity='1';

  const mv=(x,y)=>{
    const r=pad.getBoundingClientRect();
    const nx=Math.max(0,Math.min(1,(x-r.left)/r.width)),ny=Math.max(0,Math.min(1,(y-r.top)/r.height));
    cross.style.left=(nx*100)+'%';cross.style.top=(ny*100)+'%';
    // Log filter: 300Hz to 6000Hz
    const logFreq=300*Math.pow(20,nx);
    // Log volume with floor
    const vol=Math.max(0.05,Math.pow(1-ny,2)*0.3);
    if(fireLoop){
      fireLoop.filter.frequency.setTargetAtTime(logFreq,audioCtx.currentTime,0.05);
      fireLoop.gain.gain.setTargetAtTime(vol,audioCtx.currentTime,0.05);
    }
  };
  pad.addEventListener('touchstart',e=>{e.preventDefault();firePadActive=true;ghost.style.opacity='0';mv(e.touches[0].clientX,e.touches[0].clientY);});
  pad.addEventListener('touchmove',e=>{e.preventDefault();if(firePadActive)mv(e.touches[0].clientX,e.touches[0].clientY);});
  pad.addEventListener('touchend',()=>{
    firePadActive=false;cross.style.left='50%';cross.style.top='50%';
    if(fireLoop)fireLoop.gain.gain.linearRampToValueAtTime(0,audioCtx.currentTime+0.3);
  });

  const sa=document.getElementById('fireSwipeArea');let ss=null;
  sa.addEventListener('touchstart',e=>{e.preventDefault();swipeGhost.style.opacity='0';ss={x:e.touches[0].clientX,y:e.touches[0].clientY};});
  sa.addEventListener('touchmove',e=>{
    e.preventDefault();if(!ss)return;const now=Date.now();if(now-fireLastSwipe<80)return;
    const dx=e.touches[0].clientX-ss.x,dy=e.touches[0].clientY-ss.y,dist=Math.sqrt(dx*dx+dy*dy);
    if(dist>20){fireLastSwipe=now;const r=sa.getBoundingClientRect();
      spawnFlame(e.touches[0].clientX-r.left,e.touches[0].clientY-r.top,sa);
      triggerFlameSound(dist/200);ss={x:e.touches[0].clientX,y:e.touches[0].clientY};}
  });
  sa.addEventListener('touchend',()=>{ss=null;});
}
function spawnFlame(x,y,c){const el=document.createElement('div');el.className='flame-particle';el.style.background=`hsl(${10+Math.random()*30},90%,55%)`;el.style.left=x+'px';el.style.top=y+'px';const s=6+Math.random()*10;el.style.width=s+'px';el.style.height=s+'px';c.appendChild(el);setTimeout(()=>el.remove(),800);}
function triggerFlameSound(v){
  const t=audioCtx.currentTime,bs=audioCtx.sampleRate*0.15,buf=audioCtx.createBuffer(1,bs,audioCtx.sampleRate);
  const d=buf.getChannelData(0);for(let i=0;i<bs;i++)d[i]=Math.random()*2-1;
  const s=audioCtx.createBufferSource();s.buffer=buf;
  const bp=audioCtx.createBiquadFilter();bp.type='bandpass';bp.frequency.value=1000+Math.random()*3000;bp.Q.value=2;
  const e=audioCtx.createGain();e.gain.setValueAtTime(Math.min(v,1)*0.2,t);e.gain.exponentialRampToValueAtTime(0.001,t+0.15);
  s.connect(bp);bp.connect(e);e.connect(audioCtx.destination);s.start(t);
}
function cleanupFire(){
  if(fireLoop){
    fireLoop.gain.gain.linearRampToValueAtTime(0,audioCtx.currentTime+0.15);
    setTimeout(()=>{try{fireLoop.source.stop();}catch(e){}fireLoop=null;},200);
  }else{fireLoop=null;}
}

// ═══════════════════════════════════
// EARTH — earthquake + MP3 bed
// ═══════════════════════════════════
let earthDrone=null,earthBed=null,earthAnimFrame=null,earthStartTime=null,earthLastVib=0,earthPulseContainer=null,earthQuaking=false,earthFirstQuake=true;
const QUAKE_TIMES=[6000,11000,21000];
let earthQuakeTime=6000;

function createDrone(f,t,d){
  const o1=audioCtx.createOscillator(),o2=audioCtx.createOscillator();
  const g=audioCtx.createGain(),fl=audioCtx.createBiquadFilter();
  o1.type=t||'sine';o1.frequency.value=f;o2.type='sine';o2.frequency.value=f*1.002;
  if(d){o1.detune.value=d;o2.detune.value=-d;}
  fl.type='lowpass';fl.frequency.value=800;fl.Q.value=2;g.gain.value=0;
  o1.connect(fl);o2.connect(fl);fl.connect(g);g.connect(audioCtx.destination);
  o1.start();o2.start();
  return{osc1:o1,osc2:o2,gain:g,filter:fl};
}

function initEarth(){
  showCue('earthCue');
  earthDrone=createDrone(55,'sine',2);earthDrone.filter.frequency.value=400;
  const ta=document.getElementById('earthTouch');
  earthPulseContainer=ta.parentElement;
  ta.addEventListener('touchstart',earthTS);
  ta.addEventListener('touchend',earthTE);
  ta.addEventListener('touchcancel',earthTE);
}

function earthTS(e){
  e.preventDefault();hideCue('earthCue');
  earthStartTime=Date.now();earthLastVib=0;earthQuaking=false;
  earthQuakeTime=earthFirstQuake?6000:QUAKE_TIMES[Math.floor(Math.random()*QUAKE_TIMES.length)];
  earthDrone.gain.gain.setValueAtTime(0,audioCtx.currentTime);

  // Start MP3 bed
  earthBed=playBuffer('earth_long',true,0);
  earthChargeLoop();
}

function earthChargeLoop(){
  if(!earthStartTime)return;
  const elapsed=Date.now()-earthStartTime;
  const ta=document.getElementById('earthTouch');

  if(earthQuaking){
    earthStartTime=Date.now();earthQuaking=false;earthLastVib=0;
    earthQuakeTime=QUAKE_TIMES[Math.floor(Math.random()*QUAKE_TIMES.length)];
    earthDrone.gain.gain.setValueAtTime(0.02,audioCtx.currentTime);
    if(earthBed)earthBed.gain.gain.setValueAtTime(0.01,audioCtx.currentTime);
    ta.style.boxShadow='none';ta.style.borderColor='rgba(139,94,60,0.25)';ta.style.background='transparent';
    earthAnimFrame=requestAnimationFrame(earthChargeLoop);
    return;
  }

  const progress=Math.min(elapsed/earthQuakeTime,1);

  // Synth drone volume
  earthDrone.gain.gain.setValueAtTime(progress*0.3,audioCtx.currentTime);
  // MP3 bed always softer than synth
  if(earthBed)earthBed.gain.gain.setValueAtTime(progress*0.15,audioCtx.currentTime);

  // Progressive glow
  const glowSize=20+progress*80,glowOp=0.05+progress*0.35;
  const borderOp=0.25+progress*0.6,bgOp=progress*0.2;
  ta.style.boxShadow=`0 0 ${glowSize}px rgba(139,94,60,${glowOp})`;
  ta.style.borderColor=`rgba(139,94,60,${borderOp})`;
  ta.style.background=`rgba(139,94,60,${bgOp})`;

  // Progressive haptic
  const now=Date.now(),vibInterval=800-progress*650;
  if(now-earthLastVib>vibInterval){
    const vibStr=Math.round(30+progress*120);
    if(navigator.vibrate)navigator.vibrate(vibStr);
    earthLastVib=now;spawnEarthPulse();
  }

  if(progress>=1){triggerEarthquake();return;}
  earthAnimFrame=requestAnimationFrame(earthChargeLoop);
}

function triggerEarthquake(){
  earthQuaking=true;earthFirstQuake=false;
  earthQuakeTime=QUAKE_TIMES[Math.floor(Math.random()*QUAKE_TIMES.length)];
  const ta=document.getElementById('earthTouch');
  if(navigator.vibrate)navigator.vibrate([200,80,300,80,200]);
  const page=document.getElementById('earth-page');
  page.style.animation='screenShake 0.6s ease';
  setTimeout(()=>{page.style.animation='';},700);
  ta.style.boxShadow='0 0 120px rgba(139,94,60,0.7)';
  ta.style.borderColor='rgba(139,94,60,1)';
  ta.style.background='rgba(139,94,60,0.35)';
  earthDrone.gain.gain.setValueAtTime(0.45,audioCtx.currentTime);
  earthDrone.gain.gain.linearRampToValueAtTime(0.02,audioCtx.currentTime+1.5);
  if(earthBed){
    earthBed.gain.gain.setValueAtTime(0.25,audioCtx.currentTime);
    earthBed.gain.gain.linearRampToValueAtTime(0.01,audioCtx.currentTime+1.5);
  }
  setTimeout(()=>{if(earthStartTime)earthAnimFrame=requestAnimationFrame(earthChargeLoop);},1500);
}

function earthTE(){
  earthStartTime=null;earthQuaking=false;
  if(earthAnimFrame){cancelAnimationFrame(earthAnimFrame);earthAnimFrame=null;}
  if(navigator.vibrate)navigator.vibrate(0);
  const ta=document.getElementById('earthTouch');
  ta.style.boxShadow='none';ta.style.borderColor='rgba(139,94,60,0.25)';ta.style.background='transparent';
  if(earthDrone)earthDrone.gain.gain.linearRampToValueAtTime(0,audioCtx.currentTime+0.3);
  if(earthBed){
    earthBed.gain.gain.linearRampToValueAtTime(0,audioCtx.currentTime+0.3);
    setTimeout(()=>{try{earthBed.source.stop();}catch(e){}earthBed=null;},350);
  }
  showCue('earthCue');
}

function spawnEarthPulse(){
  const el=document.createElement('div');el.className='earth-pulse';
  const ta=document.getElementById('earthTouch');
  const r=ta.getBoundingClientRect(),pr=earthPulseContainer.getBoundingClientRect();
  const sz=ta.clientWidth;el.style.width=sz+'px';el.style.height=sz+'px';
  el.style.left=(r.left-pr.left+r.width/2-sz/2)+'px';
  el.style.top=(r.top-pr.top+r.height/2-sz/2)+'px';
  earthPulseContainer.appendChild(el);setTimeout(()=>el.remove(),1000);
}

function cleanupEarth(){
  earthStartTime=null;earthQuaking=false;earthFirstQuake=true;
  if(earthAnimFrame){cancelAnimationFrame(earthAnimFrame);earthAnimFrame=null;}
  if(earthDrone){try{earthDrone.osc1.stop();earthDrone.osc2.stop();}catch(e){}earthDrone=null;}
  if(earthBed){try{earthBed.source.stop();}catch(e){}earthBed=null;}
  if(navigator.vibrate)navigator.vibrate(0);
  const ta=document.getElementById('earthTouch');
  ta.style.boxShadow='none';ta.style.borderColor='rgba(139,94,60,0.25)';ta.style.background='transparent';
  ta.removeEventListener('touchstart',earthTS);ta.removeEventListener('touchend',earthTE);ta.removeEventListener('touchcancel',earthTE);
}

document.addEventListener('touchmove',e=>{if(currentElement)e.preventDefault();},{passive:false});
</script>
</body>
</html>
